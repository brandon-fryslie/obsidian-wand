# Sprint Plan: Minimal Viable E2E Testing Setup

**Generated**: 2025-12-17-000242
**Topic**: Playwright E2E Testing for Obsidian Plugin
**Source STATUS**: STATUS-20251216-235920.md
**Sprint Goal**: Get a single e2e test running that launches Obsidian, connects via CDP, and verifies the plugin loads.

---

## Executive Summary

**Current State** (from STATUS):
- Unit tests: Comprehensive and passing (Jest)
- Playwright: Installed but unconfigured
- E2E infrastructure: 0% complete
- Test vault setup: Script exists and works
- Critical blocker: No proven method to launch Obsidian with remote debugging

**Gap Analysis**:
The STATUS report identifies 16 tasks spanning 37-56 hours to reach "production ready" E2E testing. This sprint focuses on the **Priority 1 critical path only** (4 tasks, 10-16 hours) to unblock E2E testing and prove the concept works.

**Sprint Scope**:
- 3 deliverables max (as requested)
- Focus: Minimal viable setup that proves we can automate Obsidian
- Out of scope: Full coverage, CI, LLM mocking, multiple test scenarios

**Total Work Items**: 6 (P0: 4, P1: 2)
**Estimated Complexity**: HIGH (research-heavy for Obsidian CDP connection)

---

## Work Items by Priority

### P0 (Critical): Foundation - Must Complete This Sprint

#### P0-1: Research and Document Obsidian CDP Launch Strategy

**Status**: Not Started
**Effort**: LARGE (4-8 hours research + experimentation)
**Dependencies**: None (blocking all other work)
**Spec Reference**: N/A (infrastructure) • **Status Reference**: STATUS-20251216-235920.md § "Obsidian Automation Strategy" (lines 106-141)

**Description**:
The STATUS report identifies this as the **CRITICAL BLOCKER**. Obsidian is a packaged Electron app with no documented automation API. We need to prove we can launch it with Chrome DevTools Protocol (CDP) enabled so Playwright can connect.

Three options were researched in STATUS:
- Option A: Playwright Electron mode (experimental, risky)
- Option B: CDP with `--remote-debugging-port` (recommended, lower risk)
- Option C: Obsidian URI (limited, not truly E2E)

This task resolves the ambiguity through hands-on experimentation.

**Acceptance Criteria**:
- [ ] Documented method to launch Obsidian with `--remote-debugging-port=9222` flag
- [ ] Manual verification: Can connect to `http://localhost:9222` and see Electron targets
- [ ] Shell script or wrapper that launches Obsidian in debug mode exists
- [ ] Documentation in `e2e/README.md` explains the approach and any gotchas
- [ ] Known issues documented (e.g., "Trust this plugin?" prompt handling)

**Technical Notes**:
- macOS: Obsidian executable at `/Applications/Obsidian.app/Contents/MacOS/Obsidian`
- Electron apps typically accept `--remote-debugging-port` flag
- May need to pass additional flags: `--no-sandbox`, `--disable-dev-shm-usage`
- Test with: `curl http://localhost:9222/json/version` (should return Electron version)
- Research sources: Obsidian forums, Electron testing docs, similar plugin automation attempts

---

#### P0-2: Create Playwright Configuration

**Status**: Not Started
**Effort**: SMALL (1 hour)
**Dependencies**: None
**Spec Reference**: N/A (infrastructure) • **Status Reference**: STATUS-20251216-235920.md § "Playwright Configuration" (lines 77-105)

**Description**:
Create `playwright.config.ts` with settings appropriate for Electron app testing. Must configure serial execution (Obsidian is single-instance), appropriate timeouts (app launch is slow), and failure artifacts.

**Acceptance Criteria**:
- [ ] File `playwright.config.ts` exists in repo root
- [ ] Config sets `testDir: './e2e'`
- [ ] Config sets `timeout: 60000` (60 seconds for slow Obsidian launch)
- [ ] Config sets `workers: 1` (serial execution, no parallel tests)
- [ ] Config enables `trace: 'on-first-retry'` and `screenshot: 'only-on-failure'`
- [ ] Running `pnpm playwright test` reads the config without errors

**Technical Notes**:
- Don't configure browser launch here - will be handled in test fixtures
- Keep config minimal for this sprint
- Can add reporters, retries, etc. in future sprints

---

#### P0-3: Build Obsidian Launcher Helper

**Status**: Not Started
**Effort**: MEDIUM (2-4 hours)
**Dependencies**: P0-1 (must know how to launch with CDP)
**Spec Reference**: N/A (infrastructure) • **Status Reference**: STATUS-20251216-235920.md § "Test Helpers & Utilities" (lines 276-299)

**Description**:
Create reusable TypeScript helper that launches Obsidian with CDP enabled, waits for connection readiness, and provides cleanup. This is the core infrastructure all E2E tests will use.

**Acceptance Criteria**:
- [ ] File `e2e/helpers/obsidian-launcher.ts` exists
- [ ] Exports `launchObsidian(vaultPath: string, debugPort?: number): Promise<Browser>` function
- [ ] Function spawns Obsidian process with `--remote-debugging-port` flag
- [ ] Function connects to CDP using `playwright.chromium.connectOverCDP()`
- [ ] Function waits for connection and returns Playwright `Browser` instance
- [ ] Exports `closeObsidian(browser: Browser, process: ChildProcess): Promise<void>` cleanup function
- [ ] Cleanup function gracefully closes browser and kills Obsidian process
- [ ] Manual test script verifies launch/close cycle works

**Technical Notes**:
- Use `spawn` from `child_process` to launch Obsidian
- CDP endpoint: `http://localhost:${debugPort}`
- Add timeout for connection attempt (fail fast if Obsidian won't start)
- Consider using `tree-kill` package for cross-platform process cleanup
- May need retry logic if CDP connection is slow to establish

---

#### P0-4: Write First Smoke Test

**Status**: Not Started
**Effort**: MEDIUM (2-3 hours)
**Dependencies**: P0-2, P0-3
**Spec Reference**: README.md § "Features" (lines 5-14) • **Status Reference**: STATUS-20251216-235920.md § "E2E Test Files" (lines 148-164)

**Description**:
Create the first working E2E test that proves the entire chain works: launch Obsidian → connect via Playwright → verify plugin loaded → cleanup. This is the "Hello World" that validates all infrastructure.

**Acceptance Criteria**:
- [ ] File `e2e/smoke.spec.ts` exists
- [ ] Test "plugin appears in Obsidian sidebar" launches Obsidian using `launchObsidian()` helper
- [ ] Test waits for Obsidian UI to be visible (e.g., workspace loaded)
- [ ] Test verifies plugin ribbon icon exists (selector: `[aria-label*="Tool-Calling Agent"]` or similar)
- [ ] Test closes Obsidian cleanly via `closeObsidian()` helper
- [ ] Running `pnpm playwright test e2e/smoke.spec.ts` passes consistently (3/3 runs)
- [ ] Test completes in <60 seconds

**Technical Notes**:
- Use test vault from `~/obsidian-test-vault` (configured in justfile)
- Plugin must already be installed in vault (via `just setup`)
- First run may show "Trust this plugin?" - document this in test comments
- Consider adding `test.setTimeout(90000)` for first test while iterating
- Selector strategy: Inspect Obsidian UI with DevTools to find stable selectors

---

### P1 (High): Enhanced Developer Experience

#### P1-1: Add Just Recipes for E2E

**Status**: Not Started
**Effort**: SMALL (30 minutes)
**Dependencies**: P0-4 (need working tests first)
**Spec Reference**: N/A (developer tooling) • **Status Reference**: STATUS-20251216-235920.md § "Just Recipes for E2E" (lines 346-381)

**Description**:
Add convenient `just` commands for running E2E tests in different modes (headless, headed, debug). Makes it easy for developers to run and troubleshoot tests.

**Acceptance Criteria**:
- [ ] Recipe `test:e2e` runs `pnpm playwright test` (headless mode)
- [ ] Recipe `test:e2e:headed` runs `pnpm playwright test --headed` (visible browser)
- [ ] Recipe `test:e2e:debug` runs `PWDEBUG=1 pnpm playwright test` (Playwright inspector)
- [ ] Recipe `setup:e2e` runs `just build && just setup` (combined setup for E2E)
- [ ] All recipes documented in `justfile` comments
- [ ] Running `just --list` shows new E2E recipes

**Technical Notes**:
- Keep recipes simple - just wrappers around playwright commands
- Don't add `test:all` recipe yet (wait for more test coverage)
- Future: Can add `test:e2e:smoke` to run only smoke tests

---

#### P1-2: Create E2E Setup Documentation

**Status**: Not Started
**Effort**: SMALL (1 hour)
**Dependencies**: P0-1, P0-4 (need working solution to document)
**Spec Reference**: N/A (documentation) • **Status Reference**: STATUS-20251216-235920.md § "First-Time Setup" ambiguity (lines 406)

**Description**:
Document how to set up and run E2E tests, including prerequisites, known issues (like "Trust plugin" prompt), and troubleshooting. Critical for onboarding contributors and future maintenance.

**Acceptance Criteria**:
- [ ] File `e2e/README.md` exists
- [ ] Documents prerequisites: Obsidian installed, test vault setup, Playwright browsers installed
- [ ] Documents how to run tests: `just setup:e2e`, `just test:e2e`
- [ ] Documents known issues: "Trust this plugin?" prompt on first run, how to pre-configure trust
- [ ] Documents Obsidian launch strategy (CDP approach, why we chose it)
- [ ] Documents how to debug failing tests: headed mode, inspector, screenshots
- [ ] Documents where to find failure artifacts: `e2e/test-results/`

**Technical Notes**:
- Include example of pre-configuring `community-plugins.json` to trust plugin
- Link to Playwright docs for advanced debugging
- Note macOS-only support (for now)
- Add troubleshooting section for common failures (CDP connection timeout, plugin not loaded)

---

## Dependency Graph

```
P0-1 (Research CDP) ──┐
                      ├─→ P0-3 (Launcher Helper) ──┐
P0-2 (Playwright cfg) ─┘                            ├─→ P0-4 (Smoke Test) ──┬─→ P1-1 (Just recipes)
                                                    │                        │
P0-1 (Research CDP) ────────────────────────────────┘                        └─→ P1-2 (Docs)
```

**Critical Path**: P0-1 → P0-3 → P0-4
**Parallel Work**: P0-2 can be done independently

---

## Recommended Sprint Execution Order

### Day 1: Unblock Infrastructure (P0-1, P0-2)
1. **P0-1: Research Obsidian CDP** (4-8 hours)
   - Experiment with launching Obsidian with debug flags
   - Test manual CDP connection
   - Document working approach
   - **STOP if this fails** - escalate blocker

2. **P0-2: Playwright Config** (1 hour, can be done in parallel)
   - Create basic config
   - Verify `pnpm playwright test` reads it

### Day 2: Build and Test (P0-3, P0-4)
3. **P0-3: Launcher Helper** (2-4 hours)
   - Implement based on P0-1 findings
   - Test manual launch/close cycle

4. **P0-4: Smoke Test** (2-3 hours)
   - Write first test
   - Iterate until passing consistently
   - **This is the sprint goal - stop here if time is limited**

### Day 3: Polish (P1-1, P1-2) - Optional
5. **P1-1: Just Recipes** (30 min)
   - Add convenience commands

6. **P1-2: Documentation** (1 hour)
   - Capture learnings from P0-1
   - Document setup process

---

## Sprint Success Criteria

**Minimum Success** (P0 only):
- [ ] Can launch Obsidian with CDP enabled
- [ ] Playwright can connect to Obsidian
- [ ] One passing E2E test verifies plugin loads
- [ ] Documented approach for future tests

**Full Success** (P0 + P1):
- [ ] All P0 items complete
- [ ] Just recipes make E2E testing easy
- [ ] Documentation enables contributors to add tests

**Sprint Complete When**:
- Running `just test:e2e` executes at least one passing E2E test
- Test verifies plugin loads in real Obsidian
- Developer can add new tests using established patterns

---

## Explicitly Out of Scope (Future Sprints)

Defer these to maintain focus on MVP:

1. **Full Test Coverage**
   - Chat interface tests
   - Plan approval flow tests
   - Execution verification tests
   - Settings persistence tests
   - Error handling tests

2. **LLM Mocking Infrastructure**
   - HTTP request interception
   - Response fixtures
   - Snapshot recording

3. **CI Integration**
   - GitHub Actions workflow
   - macOS runner configuration
   - Artifact uploads

4. **Advanced Features**
   - Test parallelization (multiple vaults)
   - Performance optimization (keep Obsidian alive between tests)
   - Cross-platform support (Windows, Linux)
   - Multiple Obsidian version testing

5. **Helper Utilities**
   - `vault-helpers.ts` (clean vault, verify files)
   - `plugin-helpers.ts` (install/enable plugin)
   - Test fixtures (sample plans, responses)

**Rationale**: Sprint 1 proves the concept works. Sprint 2+ can build on this foundation once we know Obsidian automation is viable.

---

## Risk Assessment

### High-Risk Items (May Block Sprint)

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| **Obsidian won't launch with CDP** | MEDIUM | CRITICAL | Research Electron forums, try alternative launch methods, worst case use Obsidian URI approach |
| **CDP connection is unstable** | MEDIUM | HIGH | Add retry logic, increase timeouts, research Electron-specific CDP issues |
| **Plugin doesn't load in automated Obsidian** | LOW | HIGH | Pre-configure community-plugins.json, automate "Trust" button click if needed |

### Medium-Risk Items (May Slow Sprint)

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| **UI selectors are fragile** | HIGH | MEDIUM | Use stable selectors (ARIA labels, test IDs if we add them), document selector strategy |
| **Obsidian launch is very slow** | MEDIUM | MEDIUM | Increase test timeouts, consider caching strategy for future sprints |
| **First-time setup prompts block tests** | HIGH | MEDIUM | Document manual pre-configuration, add automation in P1-2 if time allows |

---

## Questions to Clarify (Before Starting)

### Critical (May Change Approach)

1. **Is there an Obsidian developer mode or test mode?**
   - If yes, this might simplify automation significantly
   - Check: Obsidian docs, community plugins that do testing

2. **Can we modify Obsidian's Electron flags?**
   - Some packaged Electron apps have a config file for launch flags
   - Worth checking before building custom wrapper script

### Nice to Know (Won't Block Sprint)

3. **What's the target CI environment?**
   - macOS runner only? GitHub Actions vs other?
   - Affects whether we test cross-platform from the start

4. **Should E2E tests run on every commit or only on-demand?**
   - Affects whether we prioritize speed/stability for this sprint

---

## Success Metrics

Track these to validate sprint delivery:

1. **Test Reliability**: Smoke test passes 3/3 times without flakes
2. **Setup Time**: Developer can run first E2E test in <10 minutes from clone
3. **Test Speed**: Smoke test completes in <60 seconds
4. **Documentation Quality**: New contributor can add test using only `e2e/README.md`

---

## Next Sprint Preview (Future Work)

Once MVP is proven, Sprint 2 could tackle:

**Option A: Horizontal Expansion** (More Infrastructure)
- LLM mocking strategy
- Vault helper utilities
- CI/CD integration

**Option B: Vertical Expansion** (More Coverage)
- Chat interface tests (type message, submit, verify history)
- Plan preview tests (submit request, see plan, verify UI)
- First execution test (create file, verify in vault)

**Recommendation**: Choose based on Sprint 1 learnings. If CDP is stable, go vertical (more tests). If CDP is fragile, go horizontal (better infrastructure).

---

## Provenance

- **Source Evaluation**: STATUS-20251216-235920.md
- **Generated**: 2025-12-17-000242
- **Planner**: status-planner agent
- **Sprint Focus**: Minimal viable E2E setup (Priority 1 critical path only)
- **Total Estimated Effort**: 10-17 hours (P0: 10-16 hours, P1: 1.5 hours)
