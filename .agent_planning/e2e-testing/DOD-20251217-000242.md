# Definition of Done: Minimal Viable E2E Testing Setup

**Generated**: 2025-12-17-000242
**Topic**: Playwright E2E Testing for Obsidian Plugin
**Plan**: PLAN-20251217-000242.md
**Sprint Goal**: Get a single e2e test running that launches Obsidian, connects via CDP, and verifies the plugin loads.

---

## Acceptance Criteria

### P0-1: Research and Document Obsidian CDP Launch Strategy

**Deliverable**: Working method to launch Obsidian with Chrome DevTools Protocol enabled

- [ ] Documented method to launch Obsidian with `--remote-debugging-port=9222` flag
- [ ] Manual verification: Can connect to `http://localhost:9222` and see Electron targets
- [ ] Shell script or wrapper that launches Obsidian in debug mode exists
- [ ] Documentation in `e2e/README.md` explains the approach and any gotchas
- [ ] Known issues documented (e.g., "Trust this plugin?" prompt handling)

---

### P0-2: Create Playwright Configuration

**Deliverable**: `playwright.config.ts` file configured for Electron app testing

- [ ] File `playwright.config.ts` exists in repo root
- [ ] Config sets `testDir: './e2e'`
- [ ] Config sets `timeout: 60000` (60 seconds for slow Obsidian launch)
- [ ] Config sets `workers: 1` (serial execution, no parallel tests)
- [ ] Config enables `trace: 'on-first-retry'` and `screenshot: 'only-on-failure'`
- [ ] Running `pnpm playwright test` reads the config without errors

---

### P0-3: Build Obsidian Launcher Helper

**Deliverable**: Reusable TypeScript helper for launching/closing Obsidian with CDP

- [ ] File `e2e/helpers/obsidian-launcher.ts` exists
- [ ] Exports `launchObsidian(vaultPath: string, debugPort?: number): Promise<Browser>` function
- [ ] Function spawns Obsidian process with `--remote-debugging-port` flag
- [ ] Function connects to CDP using `playwright.chromium.connectOverCDP()`
- [ ] Function waits for connection and returns Playwright `Browser` instance
- [ ] Exports `closeObsidian(browser: Browser, process: ChildProcess): Promise<void>` cleanup function
- [ ] Cleanup function gracefully closes browser and kills Obsidian process
- [ ] Manual test script verifies launch/close cycle works

---

### P0-4: Write First Smoke Test

**Deliverable**: One passing E2E test that verifies plugin loads in Obsidian

- [ ] File `e2e/smoke.spec.ts` exists
- [ ] Test "plugin appears in Obsidian sidebar" launches Obsidian using `launchObsidian()` helper
- [ ] Test waits for Obsidian UI to be visible (e.g., workspace loaded)
- [ ] Test verifies plugin ribbon icon exists (selector: `[aria-label*="Tool-Calling Agent"]` or similar)
- [ ] Test closes Obsidian cleanly via `closeObsidian()` helper
- [ ] Running `pnpm playwright test e2e/smoke.spec.ts` passes consistently (3/3 runs)
- [ ] Test completes in <60 seconds

---

### P1-1: Add Just Recipes for E2E

**Deliverable**: Convenient commands for running E2E tests

- [ ] Recipe `test:e2e` runs `pnpm playwright test` (headless mode)
- [ ] Recipe `test:e2e:headed` runs `pnpm playwright test --headed` (visible browser)
- [ ] Recipe `test:e2e:debug` runs `PWDEBUG=1 pnpm playwright test` (Playwright inspector)
- [ ] Recipe `setup:e2e` runs `just build && just setup` (combined setup for E2E)
- [ ] All recipes documented in `justfile` comments
- [ ] Running `just --list` shows new E2E recipes

---

### P1-2: Create E2E Setup Documentation

**Deliverable**: Complete setup and troubleshooting guide for E2E tests

- [ ] File `e2e/README.md` exists
- [ ] Documents prerequisites: Obsidian installed, test vault setup, Playwright browsers installed
- [ ] Documents how to run tests: `just setup:e2e`, `just test:e2e`
- [ ] Documents known issues: "Trust this plugin?" prompt on first run, how to pre-configure trust
- [ ] Documents Obsidian launch strategy (CDP approach, why we chose it)
- [ ] Documents how to debug failing tests: headed mode, inspector, screenshots
- [ ] Documents where to find failure artifacts: `e2e/test-results/`

---

## Sprint Scope

**This sprint delivers**:
1. Working Obsidian CDP launch mechanism (P0-1, P0-3)
2. First passing smoke test (P0-2, P0-4)
3. Developer tooling and docs (P1-1, P1-2)

**Deferred to future sprints**:
- Full test coverage (chat, plan approval, execution, settings)
- LLM mocking infrastructure
- CI/CD integration
- Advanced features (parallelization, multi-version testing)
- Additional helper utilities (vault helpers, plugin helpers)

---

## Sprint Success Criteria

**Minimum Success** (P0 only):
- [ ] Can launch Obsidian with CDP enabled
- [ ] Playwright can connect to Obsidian
- [ ] One passing E2E test verifies plugin loads
- [ ] Documented approach for future tests

**Full Success** (P0 + P1):
- [ ] All P0 items complete
- [ ] Just recipes make E2E testing easy
- [ ] Documentation enables contributors to add tests

**Sprint Complete When**:
- [ ] Running `just test:e2e` executes at least one passing E2E test
- [ ] Test verifies plugin loads in real Obsidian
- [ ] Developer can add new tests using established patterns

---

## Validation Checklist

Before marking sprint complete, verify:

1. **Test Reliability**:
   - [ ] Smoke test passes 3 consecutive runs without modification
   - [ ] No flaky selectors or race conditions observed

2. **Setup Time**:
   - [ ] New developer can run first E2E test in <10 minutes from repo clone
   - [ ] Instructions in `e2e/README.md` are sufficient (no extra knowledge needed)

3. **Test Speed**:
   - [ ] Smoke test completes in <60 seconds on local machine
   - [ ] No unnecessary waits or delays

4. **Documentation Quality**:
   - [ ] `e2e/README.md` covers all prerequisites
   - [ ] Known issues and workarounds documented
   - [ ] Troubleshooting section addresses common failures

5. **Code Quality**:
   - [ ] TypeScript types for all helper functions
   - [ ] Error handling for Obsidian launch failures
   - [ ] Clean process cleanup on test completion

---

## Known Limitations (Acceptable for MVP)

These are known gaps that we're explicitly accepting for Sprint 1:

1. **No LLM interaction testing** - Tests only verify plugin loads, not functionality
2. **No CI integration** - Tests run locally only
3. **macOS only** - Cross-platform support deferred
4. **Manual vault setup** - Tests assume `just setup` already ran
5. **Single test scenario** - Only smoke test, no coverage of features
6. **No parallelization** - Serial execution only (workers: 1)

These will be addressed in future sprints once the foundation is proven.

---

## Escalation Criteria

Stop the sprint and escalate if:

1. **P0-1 fails** - Cannot find working method to launch Obsidian with CDP after 8 hours research
2. **CDP connection unstable** - Cannot achieve 3/3 passing runs after implementing retry logic
3. **Obsidian architecture incompatible** - Packaged app prevents automation entirely

In these cases, document findings and consider alternative approaches (Obsidian URI, manual testing, etc.)
