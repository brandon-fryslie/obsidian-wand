# Sprint Plan: Claude Code Integration via MCP Server Exposure
**Generated**: 2025-12-31-015433
**Source STATUS**: STATUS-20251231-014500.md
**Topic**: Claude Code integration via MCP Server exposure
**Approach**: Option 3 - Plugin exposes MCP server, external Claude Code connects

---

## Executive Summary

### Current State
- **ObsidianMCPServer.ts**: COMPLETE - 1032 lines, 38+ tools defined and working
- **Tool Implementation**: COMPLETE - All vault/editor/workspace/plugin tools operational
- **WebSocket Transport**: NOT STARTED - No transport layer for external connections
- **Connection Management**: NOT STARTED - No UI for connection status or configuration
- **Claude Code Integration Testing**: NOT STARTED - Not validated with real Claude Code CLI

### Gap Analysis
The evaluator identified that Option 3 (MCP Server) is the superior approach because:
- **90% already implemented** - ObsidianMCPServer.ts has all tools ready
- **Proven pattern** - obsidian-claude-code-mcp validates this approach works
- **Zero bundle size impact** - No SDK dependency needed
- **Standard MCP protocol** - Works with ANY MCP client, not just Claude Code
- **Low complexity** - No subprocess management or IPC complexity

**Critical Gap**: Missing WebSocket transport layer to expose the MCP server externally.

### Total Work
**3 Priority Levels**: P0 (1 item), P1 (2 items), P2 (2 items)
**Estimated Effort**: 10-15 hours total
**Sprint Scope**: P0 + P1 items (core functionality + testing)

### Recommended Focus
1. **Sprint 1** (P0 + P1): WebSocket transport, connection UI, Claude Code testing
2. **Sprint 2** (P2): Auto-discovery, documentation polish, cross-platform validation

---

## Backlog by Priority

---

## P0 (Critical) - Core MCP Server Transport

---

### P0-1: Add WebSocket Transport to ObsidianMCPServer

**Status**: Not Started
**Effort**: Medium (4-6 hours)
**Dependencies**: None
**Spec Reference**: CLAUDE.md - MCP Server pattern • **Status Reference**: STATUS-20251231-014500.md lines 197-221, 573-591, 693-698

#### Description
Add a WebSocket server transport layer to expose the existing ObsidianMCPServer to external MCP clients (Claude Code CLI, MCP Inspector, etc.). The MCP server tools are already fully implemented - this work only adds the network transport.

Based on the evaluator's research, the proven pattern uses:
- WebSocket server on localhost (default port 22360)
- Standard MCP JSON-RPC protocol over WebSocket
- Tool discovery via `tools/list` method
- Tool execution via `tools/call` method

#### Acceptance Criteria
- [ ] WebSocket server starts when plugin loads and ObsidianMCPServer is configured
- [ ] Server listens on configurable port (default 22360, stored in plugin settings)
- [ ] MCP protocol implemented: handles `tools/list` request and returns all 38+ tools
- [ ] MCP protocol implemented: handles `tools/call` request and routes to existing tool handlers
- [ ] Error responses follow MCP JSON-RPC error format
- [ ] Server gracefully shuts down when plugin unloads
- [ ] Unit tests verify MCP message parsing and routing
- [ ] Integration test: Connect with WebSocket client and call vault_readFile tool

#### Technical Notes
**MCP JSON-RPC Protocol** (from STATUS reference):
```json
// Tool List Request
{ "jsonrpc": "2.0", "method": "tools/list", "id": 1 }

// Tool Call
{
  "jsonrpc": "2.0",
  "method": "tools/call",
  "params": { "name": "vault_readFile", "arguments": { "path": "note.md" } },
  "id": 2
}

// Result
{
  "jsonrpc": "2.0",
  "result": { "content": [{ "type": "text", "text": "..." }] },
  "id": 2
}
```

**Implementation Approach**:
1. Install `ws` package for WebSocket server: `pnpm add ws @types/ws`
2. Create `src/services/MCPWebSocketServer.ts`:
   - Wraps ObsidianMCPServer
   - Handles WebSocket connections
   - Parses incoming JSON-RPC messages
   - Routes to appropriate MCP server methods
   - Formats responses per MCP protocol
3. Update `src/main.ts` to start/stop WebSocket server on plugin load/unload
4. Add port configuration to plugin settings

**Reference Implementation** (from obsidian-claude-code-mcp pattern):
```typescript
import { WebSocketServer } from 'ws';

const wss = new WebSocketServer({ port: 22360 });

wss.on('connection', (ws) => {
  ws.on('message', async (data) => {
    const request = JSON.parse(data.toString());
    const result = await handleMcpRequest(request);
    ws.send(JSON.stringify(result));
  });
});
```

**Existing Code to Leverage**:
- ObsidianMCPServer.ts already exports tool definitions in MCP-compatible format
- createObsidianMCPServer() returns SDK MCP server instance
- Tools already return `{ content: [{ type: "text", text: "..." }] }` format

**Risk**: If SDK's createSdkMcpServer() doesn't expose raw tool list/handler access, may need to:
- Extract tool definitions from SDK server instance
- Or implement custom MCP protocol handler that calls SDK server methods

---

## P1 (High) - Connection Management & Validation

---

### P1-1: Add Connection Management UI in Settings

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: P0-1 (WebSocket transport)
**Spec Reference**: CLAUDE.md - Plugin settings pattern • **Status Reference**: STATUS-20251231-014500.md lines 214-221, 701-708

#### Description
Add settings UI to configure and monitor the MCP WebSocket server. Users need visibility into connection status and ability to configure port/enable-disable the server.

#### Acceptance Criteria
- [ ] Settings section "Claude Code Integration (MCP Server)" added to plugin settings
- [ ] Toggle to enable/disable MCP server (default: enabled)
- [ ] Number input for port configuration (default: 22360, range: 1024-65535)
- [ ] Read-only status display shows: "Server running on port 22360" or "Server stopped"
- [ ] Active connection count displayed (e.g., "1 client connected")
- [ ] Port change takes effect immediately (restart server without plugin reload)
- [ ] Error handling: If port in use, display error and suggest alternative port
- [ ] Settings UI follows Obsidian plugin design patterns (consistent styling)

#### Technical Notes
**Settings Implementation**:
1. Add to `src/types/settings.ts`:
   ```typescript
   export interface PluginSettings {
     // ... existing settings
     mcpServer: {
       enabled: boolean;
       port: number;
     };
   }
   ```

2. Update `src/main.ts` settings UI:
   ```typescript
   containerEl.createEl("h2", { text: "Claude Code Integration (MCP Server)" });

   new Setting(containerEl)
     .setName("Enable MCP Server")
     .setDesc("Allow external Claude Code CLI to connect")
     .addToggle(toggle => toggle
       .setValue(this.settings.mcpServer.enabled)
       .onChange(async (value) => {
         this.settings.mcpServer.enabled = value;
         await this.saveSettings();
         await this.restartMCPServer();
       }));

   new Setting(containerEl)
     .setName("Port")
     .setDesc("WebSocket port (default: 22360)")
     .addText(text => text
       .setPlaceholder("22360")
       .setValue(String(this.settings.mcpServer.port))
       .onChange(async (value) => {
         const port = parseInt(value);
         if (port >= 1024 && port <= 65535) {
           this.settings.mcpServer.port = port;
           await this.saveSettings();
           await this.restartMCPServer();
         }
       }));
   ```

3. Add status monitoring in MCPWebSocketServer:
   - Track active connections in Set<WebSocket>
   - Expose getConnectionCount() method
   - Emit events on connection/disconnection

**UX Considerations**:
- Show helpful error if port 22360 is already in use
- Link to documentation for Claude Code CLI setup
- Consider adding "Copy connection command" button: `claude -s obsidian-vault`

---

### P1-2: Test with Claude Code CLI

**Status**: Not Started
**Effort**: Medium (3-4 hours)
**Dependencies**: P0-1, P1-1
**Spec Reference**: CLAUDE.md - Testing practices • **Status Reference**: STATUS-20251231-014500.md lines 360-378, 586-591, 709-716

#### Description
Validate that the MCP server works correctly with the actual Claude Code CLI. This is the acceptance test that proves the integration is production-ready.

From STATUS reference: obsidian-claude-code-mcp proves this pattern works in production. We need to validate all 38+ tools work correctly via external Claude Code.

#### Acceptance Criteria
- [ ] Claude Code CLI installed: `npm install -g @anthropic-ai/claude-code`
- [ ] Claude Code discovers Obsidian MCP server (via manual config or auto-discovery)
- [ ] Tool discovery works: `claude` shows Obsidian tools in available tools list
- [ ] File operations tested: vault_readFile, vault_writeFile, vault_createFile work correctly
- [ ] Search operations tested: vault_searchText, vault_listFiles return valid results
- [ ] Editor operations tested: editor_insertAtCursor, workspace_openFile work when file is open
- [ ] Plugin integrations tested: dataview_query, tasks_createTask work (if plugins installed)
- [ ] Error handling tested: Invalid paths return proper error messages to Claude Code
- [ ] Streaming responses: Claude Code receives and displays tool results correctly
- [ ] Cross-platform tested: Works on macOS (primary), Windows validation recommended

#### Technical Notes
**Claude Code Configuration**:
Create `.mcp.json` or equivalent in project root:
```json
{
  "mcpServers": {
    "obsidian-vault": {
      "type": "websocket",
      "url": "ws://localhost:22360"
    }
  }
}
```

**Test Scenarios** (from STATUS reference lines 586-591):
1. **Read-only operations**:
   ```
   User: "List all markdown files in my Daily Notes folder"
   Expected: Claude Code calls vault_listFiles, returns file list
   ```

2. **Write operations**:
   ```
   User: "Create a new daily note for today"
   Expected: Claude Code calls vault_createFile with timestamp, returns success
   ```

3. **Search operations**:
   ```
   User: "Find all notes mentioning 'project alpha'"
   Expected: Claude Code calls vault_searchText, returns matching files
   ```

4. **Complex workflows**:
   ```
   User: "Create a summary of all my meeting notes from this week"
   Expected: Claude Code chains: listFiles → readFile (multiple) → createFile
   ```

**Validation Checklist**:
- [ ] MCP Inspector tool shows all 38+ tools with correct schemas
- [ ] `claude -s obsidian-vault` connects successfully
- [ ] Run at least 10 diverse tool calls covering vault/editor/workspace/plugins
- [ ] Verify error messages are helpful (not raw stack traces)
- [ ] Test with Obsidian vault containing ~100 files (realistic scale)

**Known Issues to Watch For** (from STATUS reference):
- Sandbox/Flatpak restrictions on Linux (document workaround)
- PATH issues if Claude Code not in system PATH
- Port conflicts if 22360 already in use

---

## P2 (Medium) - Enhanced UX & Documentation

---

### P2-1: Add Service Discovery/Announcement

**Status**: Not Started
**Effort**: Small (2-3 hours)
**Dependencies**: P0-1
**Spec Reference**: None (enhancement) • **Status Reference**: STATUS-20251231-014500.md line 696

#### Description
Implement automatic service discovery so Claude Code can find the Obsidian MCP server without manual configuration. This reduces setup friction for users.

#### Acceptance Criteria
- [ ] mDNS/DNS-SD announcement broadcasts MCP server availability on local network
- [ ] Service advertised as `_mcp._tcp.local` with name `obsidian-vault`
- [ ] TXT records include: port, vault name, plugin version
- [ ] Claude Code auto-discovers server (if Claude Code supports discovery)
- [ ] Fallback: Generate `.mcp.json` config snippet in settings UI for manual setup
- [ ] Discovery can be disabled in settings (privacy consideration)

#### Technical Notes
**Implementation Options**:
1. **mDNS** (via `mdns` or `bonjour` npm package):
   - Advertise service on local network
   - Works for same-machine and LAN discovery
   - Requires native dependencies (may complicate build)

2. **Config File Generation** (simpler fallback):
   - Settings UI has "Copy MCP Config" button
   - Generates JSON snippet for `.mcp.json`
   - User pastes into Claude Code config manually

**Recommended**: Start with config file generation (P2-1a), add mDNS later (P2-1b) if needed.

**Risk**: mDNS may not work in Electron renderer context or may require main process. If complex, defer to future sprint.

---

### P2-2: Cross-Platform Validation & Documentation

**Status**: Not Started
**Effort**: Medium (3-4 hours)
**Dependencies**: P1-2
**Spec Reference**: CLAUDE.md (to be updated) • **Status Reference**: STATUS-20251231-014500.md lines 699-708

#### Description
Validate the MCP server works on all major platforms and create comprehensive setup documentation. From STATUS reference: Windows/Linux have unique considerations (PATH, sandboxing).

#### Acceptance Criteria
- [ ] Windows testing: MCP server starts, Claude Code connects, tools work
- [ ] Linux testing: Works on standard install (not Flatpak/Snap initially)
- [ ] macOS testing: Already validated via primary development
- [ ] Documentation: README section "Connecting Claude Code via MCP" created
- [ ] Documentation: Installation guide (install Claude Code, configure MCP, test connection)
- [ ] Documentation: Troubleshooting section (port conflicts, PATH issues, firewall)
- [ ] Documentation: Example workflows (create notes, search vault, plugin integrations)
- [ ] CLAUDE.md updated: Add MCP server architecture section
- [ ] Video/GIF: Optional screen recording showing setup flow (30 seconds)

#### Technical Notes
**Platform-Specific Testing**:
- **Windows**: Verify WebSocket server binds to localhost, no firewall issues
- **Linux**: Document Flatpak/Snap sandboxing limitations, provide workaround
- **macOS**: Already primary dev platform, just validate documentation accuracy

**Documentation Structure**:
```markdown
## Connecting Claude Code via MCP

### Prerequisites
- Obsidian with ToolAgent plugin installed
- Claude Code CLI: `npm install -g @anthropic-ai/claude-code`
- Anthropic API key

### Setup
1. Enable MCP Server in ToolAgent settings
2. Copy MCP config snippet from settings
3. Paste into `~/.claude/mcp.json` (or project-specific)
4. Run: `claude -s obsidian-vault`
5. Verify: Ask Claude to "list files in my vault"

### Troubleshooting
- Port 22360 in use: Change port in settings
- Claude Code not found: Check PATH, reinstall Claude Code
- Connection refused: Verify MCP server enabled in settings
- Tools not showing: Check console for errors, restart Obsidian
```

**Reference**: Existing plugin documentation patterns from obsidian-claude-code-mcp and obsidian-git.

---

## Dependency Graph

```
P0-1 (WebSocket Transport)
  ├─> P1-1 (Connection UI) - needs server to control
  ├─> P1-2 (Claude Code Testing) - needs transport to test
  └─> P2-1 (Auto-Discovery) - needs server to advertise

P1-1 (Connection UI)
  └─> P1-2 (Claude Code Testing) - UI helps validate status

P1-2 (Claude Code Testing)
  └─> P2-2 (Documentation) - testing informs docs

P2-1 (Auto-Discovery)
  └─> P2-2 (Documentation) - discovery config documented
```

**Parallel Work Possible**:
- P2-1 can start alongside P1-1 (both extend server)
- P2-2 documentation can be drafted during P1-2 testing

---

## Recommended Sprint Planning

### Sprint 1: Core Functionality (10-13 hours)
**Goal**: Working MCP server with Claude Code connection

**Week 1**:
- **Day 1-2**: P0-1 - WebSocket Transport (4-6 hours)
- **Day 3**: P1-1 - Connection UI (2-3 hours)
- **Day 4**: P1-2 - Claude Code Testing (3-4 hours)

**Deliverables**:
- MCP server running on localhost:22360
- Settings UI for enable/port configuration
- Validated with real Claude Code CLI
- All 38+ tools working via external connection

**Success Criteria**: User can run `claude -s obsidian-vault` and interact with Obsidian vault.

---

### Sprint 2: Polish & Documentation (5-7 hours)
**Goal**: Production-ready with documentation

**Week 2**:
- **Day 1**: P2-1 - Auto-Discovery OR Config Generation (2-3 hours)
- **Day 2**: P2-2 - Cross-Platform & Docs (3-4 hours)

**Deliverables**:
- Easy setup via auto-discovery or config snippet
- Comprehensive documentation
- Cross-platform validation (Windows/Linux/macOS)

**Success Criteria**: New user can set up in <5 minutes following docs.

---

## Risk Assessment

### LOW RISKS (Well-Understood)

**1. WebSocket Server in Electron**
- **Probability**: 5%
- **Impact**: LOW - WebSocket is standard Node.js, works in Electron
- **Mitigation**: Use `ws` package (proven in Electron apps)
- **Evidence**: Multiple Obsidian plugins use WebSocket (confirmed in research)

**2. Port Conflicts**
- **Probability**: 10%
- **Impact**: LOW - Configurable port setting mitigates
- **Mitigation**: Default to 22360, allow user configuration, detect conflicts
- **Fallback**: Settings UI suggests alternative port if 22360 in use

**3. MCP Protocol Compatibility**
- **Probability**: 15%
- **Impact**: LOW - MCP protocol is well-defined
- **Mitigation**: Follow MCP JSON-RPC spec exactly, test with MCP Inspector
- **Reference**: obsidian-claude-code-mcp proves compatibility

### MEDIUM RISKS (Require Validation)

**4. SDK MCP Server Exposure**
- **Probability**: 30%
- **Impact**: MEDIUM - May need custom protocol handler if SDK doesn't expose tools
- **Mitigation**: Test if SDK's createSdkMcpServer() provides tool list/handlers
- **Fallback**: Implement custom MCP handler that wraps SDK tools
- **Time to Validate**: 1-2 hours during P0-1

**5. Cross-Platform WebSocket Binding**
- **Probability**: 20%
- **Impact**: MEDIUM - Windows firewall, Linux sandboxing
- **Mitigation**: Bind to 127.0.0.1 only (localhost), document firewall exceptions
- **Validation**: Test on Windows/Linux in P2-2

### NO CRITICAL RISKS
Unlike the sidecar approach, MCP server has **zero critical risks**. All risks are manageable and have proven mitigations from existing plugins.

---

## Blockers and Questions

### Questions for Implementer
1. **SDK Tool Exposure**: Does `createSdkMcpServer()` expose raw tool definitions for MCP protocol? Or do we need custom handler?
   - **Validation**: Check SDK documentation and source code
   - **Test**: Call SDK server methods programmatically
   - **Fallback**: Implement custom MCP handler using Zod schemas

2. **Approval Flow Integration**: How should MCP tool calls trigger approval UI?
   - **Option A**: All MCP calls require approval (safest)
   - **Option B**: Use existing ApprovalService risk levels
   - **Option C**: MCP clients handle approval (Claude Code asks user)
   - **Recommended**: Start with Option C (Claude Code manages approval), add Option B later

3. **Multi-Vault Support**: Can MCP server expose multiple vaults simultaneously?
   - **Current**: Single active vault (plugin instance)
   - **Future**: Multiple vault connections (requires architecture change)
   - **Decision**: Single vault for Sprint 1, defer multi-vault to future

### No Blockers
All dependencies are in place:
- ✅ ObsidianMCPServer.ts exists with 38+ tools
- ✅ Tool schemas use Zod (MCP-compatible)
- ✅ ToolsLayer handles execution
- ✅ WebSocket server is standard Node.js (proven in Electron)
- ✅ MCP protocol is well-documented

---

## Success Metrics

### Sprint 1 Success
- [ ] WebSocket server starts without errors
- [ ] Claude Code connects and lists 38+ tools
- [ ] 10+ diverse tool calls work correctly
- [ ] Zero critical bugs in core tool execution
- [ ] Settings UI provides clear status feedback

### Sprint 2 Success
- [ ] Setup time <5 minutes for new users
- [ ] Documentation complete and validated
- [ ] Works on Windows/macOS/Linux
- [ ] User feedback: "Easy to set up"
- [ ] MCP Inspector shows all tools with correct schemas

### Production Readiness Checklist
- [ ] All P0 and P1 items completed
- [ ] Integration tests pass (automated where possible)
- [ ] Manual testing on 3 platforms (Win/Mac/Linux)
- [ ] Documentation reviewed by another developer
- [ ] Error messages are user-friendly (not stack traces)
- [ ] Performance: Tool calls complete in <500ms for simple operations
- [ ] No memory leaks (test with 100+ consecutive tool calls)

---

## References

### Key Files
- `/Users/bmf/code/obsidian-toolagent/src/agents/ObsidianMCPServer.ts` - 38+ tools (1032 lines)
- `/Users/bmf/code/obsidian-toolagent/src/services/ToolsLayer.ts` - Tool execution
- `/Users/bmf/code/obsidian-toolagent/src/types/settings.ts` - Settings schema
- `/Users/bmf/code/obsidian-toolagent/src/main.ts` - Plugin lifecycle

### External References
- [MCP Protocol Specification](https://modelcontextprotocol.io/) - JSON-RPC over WebSocket
- [obsidian-claude-code-mcp](https://github.com/iansinnott/obsidian-claude-code-mcp) - Proven pattern
- [Claude Code CLI Documentation](https://github.com/anthropics/claude-code) - MCP client usage
- [MCP Inspector](https://github.com/modelcontextprotocol/inspector) - Testing tool

### Research Sources (from STATUS file)
- Obsidian Forum: Execute external commands
- obsidian-git, obsidian-shellcommands (subprocess patterns)
- obsidian-claude-code-plugin (integration patterns)
- Real-world plugin analysis validates MCP approach superiority

---

**END OF SPRINT PLAN**
