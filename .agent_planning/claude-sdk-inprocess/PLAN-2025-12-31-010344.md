# Sprint Plan: Claude SDK In-Process Validation

**Generated**: 2025-12-31-010344
**Source**: STATUS-2025-12-31-005911.md
**Type**: Validation Sprint (Fail-Fast)
**Duration**: 4-8 hours
**Goal**: Prove or disprove that Claude Agent SDK works without subprocess spawning in Electron

---

## Executive Summary

**Current State**: SDK is installed (`@anthropic-ai/claude-agent-sdk@0.1.76`), MCP server with 40+ tools exists (`ObsidianMCPServer.ts`), but zero integration code. Documentation in CLAUDE.md references `ClaudeCodeAgent` but file doesn't exist.

**Critical Unknown**: Does `query()` function work with SDK MCP servers (`createSdkMcpServer()`) WITHOUT spawning the Claude Code subprocess? SDK docs say SDK servers are "handled locally in the SDK process" but don't confirm subprocess isn't required.

**Gap Analysis**:
- **Architecture**: No ClaudeCodeAgent class exists (0% complete)
- **Integration**: SDK installed but never imported or tested (0% complete)
- **Validation**: Zero tests exist for SDK integration (0% complete)
- **Compatibility**: Unknown if SDK works in Electron renderer process (0% complete)
- **Bundle Impact**: Unknown bundle size increase (not measured)

**Sprint Strategy**: Validate core assumption FIRST with minimal POC. If POC fails, STOP and enhance WandWithThinkingAgent instead. If POC succeeds, proceed with P1 integration work.

**Risk Window**: 2-3 hours to prove/disprove viability before major investment.

---

## Backlog by Priority

### P0 (Critical) - Validation Phase

These items MUST complete successfully or the entire approach is invalid.

---

#### P0-1: SDK Import Compatibility Test

**Status**: Not Started
**Effort**: Small (30 min)
**Dependencies**: None
**Spec Reference**: CLAUDE.md § ClaudeCodeAgent • **Status Reference**: STATUS-2025-12-31-005911.md § Blocker 2: Electron/Node.js Compatibility

**Description**:
Create a minimal test file that imports the Claude Agent SDK in an Obsidian plugin context. This validates that the SDK's Node.js dependencies are compatible with Electron's renderer process and that esbuild can bundle/externalize the SDK correctly.

**Acceptance Criteria**:
- [ ] Create `tests/agents/ClaudeSDKImport.test.ts` that imports SDK: `import { query, createSdkMcpServer } from '@anthropic-ai/claude-agent-sdk'`
- [ ] Test passes without import errors or runtime failures
- [ ] Verify WebAssembly modules can be accessed (tree-sitter.wasm, resvg.wasm)
- [ ] Document any esbuild configuration changes needed (external/bundle/polyfills)

**Technical Notes**:
- SDK is ESM (`type: "module"`) - ensure test config handles this
- May need to configure esbuild: `external: ['@anthropic-ai/claude-agent-sdk']`
- If imports fail, SDK is incompatible with Electron - STOP here

---

#### P0-2: In-Process MCP Server Instantiation Test

**Status**: Not Started
**Effort**: Small (30 min)
**Dependencies**: P0-1
**Spec Reference**: CLAUDE.md § ObsidianMCPServer • **Status Reference**: STATUS-2025-12-31-005911.md § Key Question: Does createSdkMcpServer() Actually Work In-Process?

**Description**:
Create an MCP server using `createSdkMcpServer()` with 2-3 simple tools and verify it returns a server instance without spawning subprocesses. This validates the fundamental assumption that SDK servers are truly in-process.

**Acceptance Criteria**:
- [ ] Create MCP server with `createSdkMcpServer()` using 3 tools: readFile, listFiles, searchText
- [ ] Verify return type is `McpSdkServerConfigWithInstance` with non-null `instance` property
- [ ] Tool handlers execute successfully and return MCP-format results: `{ content: [{ type: "text", text: "..." }] }`
- [ ] Confirm NO subprocess spawning occurs (no child_process calls, no Claude Code executable required)
- [ ] Document exact server configuration used

**Technical Notes**:
- Tool handler signature: `(args: z.infer<Schema>, extra: unknown) => Promise<CallToolResult>`
- Use existing `ObsidianMCPServer.ts` as reference for tool structure
- If subprocess spawning is detected, entire approach fails - STOP here

---

#### P0-3: SDK Query Without Subprocess Test

**Status**: Not Started
**Effort**: Medium (1-2 hours)
**Dependencies**: P0-2
**Spec Reference**: CLAUDE.md § ClaudeCodeAgent Features • **Status Reference**: STATUS-2025-12-31-005911.md § Minimum Viable Integration (if subprocess NOT required)

**Description**:
Call the SDK's `query()` function with an in-process MCP server and verify it executes tools WITHOUT requiring the Claude Code executable. This is the definitive test of whether the approach works.

**Acceptance Criteria**:
- [ ] Call `query()` with: `{ prompt: "list files in vault", options: { model: "claude-sonnet-4-5-20250929", mcpServers: { obsidian: sdkServer }, maxTurns: 10, apiKey: "test-key" } }`
- [ ] Query executes WITHOUT requiring `pathToClaudeCodeExecutable` or spawning Claude Code process
- [ ] Tools from MCP server are invoked correctly during agent loop
- [ ] Tool execution results are returned to SDK and incorporated into response
- [ ] Final response is returned successfully
- [ ] Document exact options configuration that works

**Technical Notes**:
- If query demands Claude Code executable, approach FAILS - recommend enhancing WandWithThinkingAgent
- If query works, this proves the concept is viable - proceed to P1
- Test with mock API key first (may fail on API call but should reach tool execution)
- Use `permissionMode: 'acceptEdits'` to avoid permission prompts

---

#### P0-4: Bundle Size Impact Measurement

**Status**: Not Started
**Effort**: Small (30 min)
**Dependencies**: P0-1
**Spec Reference**: CLAUDE.md § Project Structure • **Status Reference**: STATUS-2025-12-31-005911.md § Blocker 3: Bundle Size

**Description**:
Build the plugin with SDK imported and measure the bundle size increase. Obsidian community plugins should stay under 5MB. If SDK adds excessive bloat, we need externalization or tree-shaking strategy.

**Acceptance Criteria**:
- [ ] Baseline measurement: Build plugin without SDK, note `main.js` size
- [ ] Import SDK in plugin code (any file, doesn't need to execute)
- [ ] Build plugin with SDK included, note new `main.js` size
- [ ] Calculate size increase and percentage
- [ ] Document findings: if >2MB increase, investigate externalization options
- [ ] Create recommendation: bundle vs external vs abandon approach

**Technical Notes**:
- SDK includes full CLI (~700KB compressed) + WebAssembly modules (~500KB)
- Current plugin is ~500KB - acceptable range is <5MB total
- If bundled size >5MB, explore: tree-shaking, externalization, dynamic import

---

### P1 (High) - Integration Phase

**ONLY proceed if ALL P0 items succeed**

---

#### P1-1: Create ClaudeCodeAgent Class

**Status**: Not Started
**Effort**: Medium (2-3 hours)
**Dependencies**: P0-3 (query works), P0-4 (bundle acceptable)
**Spec Reference**: CLAUDE.md § Adding a New Agent • **Status Reference**: STATUS-2025-12-31-005911.md § Minimum Viable Integration Phase 2

**Description**:
Create the ClaudeCodeAgent class implementing the Agent interface. Wire in SDK's `query()` function with the in-process MCP server containing all 40+ Obsidian tools. Handle streaming, state management, and abort functionality.

**Acceptance Criteria**:
- [ ] Create `src/agents/ClaudeCodeAgent.ts` implementing Agent interface
- [ ] Constructor accepts `AgentDependencies` (apiKey, toolsLayer, settings)
- [ ] `handleUserMessage()` calls SDK's `query()` with user prompt and MCP server
- [ ] State transitions: idle → thinking (during query) → idle
- [ ] Support abort via AbortController passed to query options
- [ ] Stream events from query and emit state updates via `onStateChange` callback
- [ ] Return AgentResponse with type "message" containing final response text
- [ ] Handle errors and return AgentResponse with type "error"

**Technical Notes**:
- Reuse ObsidianMCPServer.ts for tool definitions (already has all 40+ tools)
- Query options: `{ model, apiKey, mcpServers, maxTurns: 10, permissionMode }`
- State management pattern: see WandAgent.ts for reference
- No plan generation needed - SDK handles agent loop internally

---

#### P1-2: Wire All Obsidian MCP Tools

**Status**: Not Started
**Effort**: Medium (2-3 hours)
**Dependencies**: P1-1
**Spec Reference**: CLAUDE.md § Obsidian MCP Tools • **Status Reference**: STATUS-2025-12-31-005911.md § Existing Code Reuse

**Description**:
Connect all 40+ tools from `ObsidianMCPServer.ts` to the ClaudeCodeAgent. Ensure tool handlers correctly call `ToolsLayer.executeTool()` and return MCP-format results. Test that tools execute in-process within the plugin.

**Acceptance Criteria**:
- [ ] All tools from ObsidianMCPServer.ts are registered with createSdkMcpServer()
- [ ] Tool handlers call `toolsLayer.executeTool(toolName, args, context)` correctly
- [ ] Tool results are converted to MCP format: `{ content: [{ type: "text", text: JSON.stringify(result) }] }`
- [ ] Test 5 representative tools across categories: vault_readFile (read), vault_createFile (write), dataview_query (plugin), editor_getSelection (editor), workspace_getContext (workspace)
- [ ] All tested tools execute successfully without errors
- [ ] Tool execution stays in-process (no subprocess spawning)

**Technical Notes**:
- ObsidianMCPServer.ts already has the tools defined correctly
- May need to adjust tool handler signature to match SDK expectations
- Context object (activeFile, selection, etc.) needs to be passed to handlers
- Error handling: wrap tool execution in try/catch, return error in MCP format

---

#### P1-3: Permission Integration

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: P1-2
**Spec Reference**: CLAUDE.md § ApprovalService • **Status Reference**: STATUS-2025-12-31-005911.md § Ambiguities Found (Permission Callbacks)

**Description**:
Integrate SDK's permission system with Obsidian's existing ApprovalService. Map SDK's `canUseTool` callback to the approval flow used by WandAgent and MiniAgent.

**Acceptance Criteria**:
- [ ] Implement `canUseTool` callback in query options: `async (toolName: string, args: unknown) => Promise<boolean>`
- [ ] Callback uses ApprovalService.checkApproval() to determine if tool needs approval
- [ ] High-risk tools (writeFile, delete, rename, commands.run) trigger approval UI
- [ ] Safe tools (readFile, listFiles, searchText) auto-approve
- [ ] User can approve/deny via existing approval modal
- [ ] Denied tools result in SDK receiving false, approved tools receive true
- [ ] Test approval flow with high-risk tool (vault_writeFile) and verify modal appears

**Technical Notes**:
- ApprovalService already categorizes tools by risk level (safe/low/high)
- May need to adapt approval modal to work with SDK's streaming flow
- Consider permission caching to avoid repeated prompts for same tool

---

#### P1-4: Agent Registration and Settings

**Status**: Not Started
**Effort**: Small (1 hour)
**Dependencies**: P1-1
**Spec Reference**: CLAUDE.md § Adding a New Agent (steps 2-5) • **Status Reference**: STATUS-2025-12-31-005911.md § Implementation Assessment

**Description**:
Register ClaudeCodeAgent in the AgentRegistry and add it to plugin settings UI. Users should be able to select "Claude Code Agent" as their agent type.

**Acceptance Criteria**:
- [ ] Create `src/agents/ClaudeCodeAgentFactory.ts` implementing AgentFactory
- [ ] Register factory in PluginServices.ts: `agentRegistry.register("claude-code", new ClaudeCodeAgentFactory())`
- [ ] Add "claude-code" to AgentType union in types/settings.ts
- [ ] Add dropdown option in main.ts settings: `"Claude Code Agent - Full autonomous agent with SDK"`
- [ ] Test: Select agent in settings, create new chat, verify ClaudeCodeAgent is instantiated
- [ ] Verify agent appears in agent list with correct name and description

**Technical Notes**:
- Follow same pattern as WandAgentFactory and MiniAgentFactory
- Factory should pass AgentDependencies to constructor
- Settings UI already supports multiple agents via dropdown

---

#### P1-5: Basic Integration Tests

**Status**: Not Started
**Effort**: Medium (2-3 hours)
**Dependencies**: P1-4
**Spec Reference**: CLAUDE.md § Testing • **Status Reference**: STATUS-2025-12-31-005911.md § Missing Checks (implementer should create)

**Description**:
Create integration tests for ClaudeCodeAgent covering the full message flow: user input → SDK query → tool execution → response. Verify agent works end-to-end in test environment.

**Acceptance Criteria**:
- [ ] Create `tests/agents/ClaudeCodeAgent.test.ts` with test suite
- [ ] Test: Agent initializes successfully with mock dependencies
- [ ] Test: handleUserMessage() calls SDK query and returns response
- [ ] Test: Tools are executed during agent loop (mock tool handlers)
- [ ] Test: State transitions correctly (idle → thinking → idle)
- [ ] Test: Abort functionality works (abortController stops query)
- [ ] Test: Error handling returns AgentResponse with type "error"
- [ ] All tests pass with 100% success rate

**Technical Notes**:
- Use Jest's mock functions for ToolsLayer and SDK dependencies
- May need to mock SDK's query function to avoid real API calls
- See WandAgent.test.ts and MiniAgent.test.ts for test patterns
- Focus on integration behavior, not unit testing every detail

---

### P2 (Medium) - Enhancement Phase

**ONLY proceed if P0 and P1 are complete AND user wants to continue**

---

#### P2-1: Streaming UI Updates

**Status**: Not Started
**Effort**: Medium (2-3 hours)
**Dependencies**: P1-1
**Spec Reference**: CLAUDE.md § ClaudeCodeAgent Features • **Status Reference**: STATUS-2025-12-31-005911.md § Minimum Viable Integration Phase 3

**Description**:
Implement real-time streaming of SDK events to the UI. Show users what the agent is thinking, which tools are being executed, and intermediate results as they happen.

**Acceptance Criteria**:
- [ ] Subscribe to SDK query events: thinking, tool_use, tool_result, message_delta
- [ ] Emit state updates for each event via onStateChange callback
- [ ] UI displays current thinking text as it streams
- [ ] UI shows tool execution in progress with tool name and args
- [ ] UI shows tool results as they complete
- [ ] Final message is displayed when query completes
- [ ] Test: Verify UI updates in real-time during multi-turn agent loop

**Technical Notes**:
- SDK query returns async generator or event emitter
- May need to extend AgentState type to include streaming events
- ChatView.svelte will need updates to render streaming state

---

#### P2-2: Session Management

**Status**: Not Started
**Effort**: Small (1-2 hours)
**Dependencies**: P1-1
**Spec Reference**: CLAUDE.md § Request Flow • **Status Reference**: STATUS-2025-12-31-005911.md § Minimum Viable Integration Phase 3

**Description**:
Add optional session management to preserve conversation context across multiple queries. SDK supports session IDs to maintain agent state and history.

**Acceptance Criteria**:
- [ ] Generate unique session ID per chat tab
- [ ] Pass sessionId to query options: `{ sessionId: chatId }`
- [ ] Verify SDK preserves context across multiple messages in same chat
- [ ] Test: Send 3 messages in sequence, verify agent remembers previous context
- [ ] Add setting to enable/disable session persistence
- [ ] Document session lifecycle (when created/destroyed)

**Technical Notes**:
- Session IDs should be per ChatController instance
- Consider clearing sessions on plugin reload or chat tab close
- May impact memory usage if sessions accumulate

---

#### P2-3: Custom System Prompt

**Status**: Not Started
**Effort**: Small (1 hour)
**Dependencies**: P1-1
**Spec Reference**: CLAUDE.md § WandAgent Philosophy • **Status Reference**: STATUS-2025-12-31-005911.md § Ambiguities Found (System Prompt)

**Description**:
Allow customization of SDK's system prompt to better align with Obsidian knowledge management use cases. Default SDK prompt is generic - we want Obsidian-specific guidance.

**Acceptance Criteria**:
- [ ] Add `systemPrompt` field to plugin settings
- [ ] Default prompt emphasizes: note organization, linking, metadata, knowledge management
- [ ] Pass custom prompt to query options: `{ systemPrompt: settings.systemPrompt }`
- [ ] Test: Verify custom prompt affects agent behavior (agent suggests note organization)
- [ ] Document recommended prompt structure for Obsidian use case

**Technical Notes**:
- See WandAgent's system prompt for inspiration
- Prompt should mention: Obsidian vault, markdown notes, links, tags, frontmatter
- Keep it concise - SDK has its own base prompt

---

### P3 (Low) - Optimization Phase

**Deferred until core functionality proven valuable**

---

#### P3-1: Bundle Size Optimization

**Status**: Not Started
**Effort**: Medium (2-4 hours)
**Dependencies**: P1-1, P0-4
**Spec Reference**: CLAUDE.md § Project Structure • **Status Reference**: STATUS-2025-12-31-005911.md § Blocker 3: Bundle Size

**Description**:
Optimize plugin bundle size if SDK adds excessive bloat. Explore tree-shaking, externalization, or dynamic imports to keep plugin under 5MB.

**Acceptance Criteria**:
- [ ] Analyze bundle composition to identify SDK's contribution
- [ ] Explore tree-shaking: remove unused SDK exports
- [ ] Test externalization: mark SDK as external in esbuild config
- [ ] Test dynamic import: lazy load SDK only when ClaudeCodeAgent is used
- [ ] Achieve bundle size <5MB total (ideally <2MB)
- [ ] Verify plugin loads correctly after optimization
- [ ] Document chosen optimization strategy

**Technical Notes**:
- Current plugin ~500KB, SDK could add 1-2MB
- Externalization requires users to install SDK separately (bad UX)
- Dynamic import is cleanest solution if bundle is too large

---

#### P3-2: Error Handling and Retry Logic

**Status**: Not Started
**Effort**: Medium (2-3 hours)
**Dependencies**: P1-1
**Spec Reference**: CLAUDE.md § Key Patterns (Retry logic) • **Status Reference**: STATUS-2025-12-31-005911.md § Minimum Viable Integration Phase 3

**Description**:
Add robust error handling and retry logic for SDK queries. Handle API errors, network failures, rate limits, and tool execution failures gracefully.

**Acceptance Criteria**:
- [ ] Wrap query() in try/catch to handle SDK exceptions
- [ ] Retry on transient errors (network, rate limit) up to 3 times with exponential backoff
- [ ] Detect API key errors and show helpful message to configure settings
- [ ] Handle tool execution errors without crashing agent loop
- [ ] Return user-friendly error messages via AgentResponse
- [ ] Log detailed errors to console for debugging
- [ ] Test: Verify retry logic with simulated network failure

**Technical Notes**:
- SDK may have built-in retry logic - investigate before implementing
- Use existing retry patterns from WandAgent.ts
- Error messages should be actionable (tell user how to fix)

---

## Dependency Graph

```
P0-1 (SDK Import Test)
  │
  ├─→ P0-2 (MCP Server Test)
  │     │
  │     └─→ P0-3 (Query Test) ──→ DECISION GATE
  │                                  │
  │                                  ├─ FAIL → STOP, enhance WandWithThinkingAgent
  │                                  │
  │                                  └─ SUCCESS → Continue
  │
  └─→ P0-4 (Bundle Size) ──→ DECISION GATE
                                │
                                ├─ >5MB → Investigate P3-1 or STOP
                                │
                                └─ <5MB → Continue

[If P0 succeeds]

P1-1 (ClaudeCodeAgent Class)
  │
  ├─→ P1-2 (Wire Tools)
  │     │
  │     └─→ P1-3 (Permissions)
  │
  ├─→ P1-4 (Registration)
  │     │
  │     └─→ P1-5 (Integration Tests)
  │
  ├─→ P2-1 (Streaming UI)
  ├─→ P2-2 (Session Management)
  ├─→ P2-3 (Custom Prompt)
  │
  └─→ P3-1 (Bundle Optimization)
      P3-2 (Error Handling)
```

---

## Recommended Sprint Execution

### Phase 1: Validation (2-3 hours) - CRITICAL

Execute P0-1 through P0-3 in sequence:

1. **P0-1**: Import test (30 min) → If FAIL: STOP
2. **P0-2**: MCP server test (30 min) → If FAIL: STOP
3. **P0-3**: Query test (1-2 hours) → If FAIL: STOP
4. **P0-4**: Bundle size (30 min) → If >5MB: Investigate or STOP

**DECISION GATE**: If any P0 item fails, ABANDON this approach and recommend enhancing WandWithThinkingAgent instead. Document exact failure mode.

### Phase 2: Integration (6-8 hours) - ONLY if P0 succeeds

Execute P1 items:

5. **P1-1**: ClaudeCodeAgent class (2-3 hours)
6. **P1-2**: Wire tools (2-3 hours)
7. **P1-3**: Permissions (1-2 hours)
8. **P1-4**: Registration (1 hour)
9. **P1-5**: Integration tests (2-3 hours)

**CHECKPOINT**: Compare ClaudeCodeAgent vs WandWithThinkingAgent. If SDK version isn't materially better, consider stopping here.

### Phase 3: Enhancement (OPTIONAL)

Only if Phase 2 delivers value:

10. **P2-1**: Streaming UI
11. **P2-2**: Session management
12. **P2-3**: Custom prompt

### Phase 4: Optimization (DEFERRED)

Only if plugin is heavily used:

13. **P3-1**: Bundle optimization
14. **P3-2**: Error handling

---

## Risk Assessment

### CRITICAL RISKS

| Risk | Probability | Impact | Mitigation | Fallback |
|------|-------------|--------|------------|----------|
| **SDK requires subprocess** | 60% | KILLS approach | Test immediately with P0-3 | Enhance WandWithThinkingAgent |
| **Electron incompatibility** | 30% | KILLS approach | Test early with P0-1 | Same as above |
| **Bundle size >5MB** | 50% | MEDIUM-HIGH | Measure with P0-4, optimize with P3-1 | External or abandon |

### MEDIUM RISKS

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| **Permission system mismatch** | 40% | MEDIUM | Use canUseTool callback, map to ApprovalService |
| **API key configuration issues** | 20% | MEDIUM | Store in settings, pass via options |
| **SDK vs knockoff not better** | 50% | LOW-MEDIUM | Compare after P1 completion |

---

## Success Criteria

**Sprint is successful if:**

1. **P0 items pass** → Approach is viable (SDK works in Electron without subprocess)
2. **Bundle size acceptable** → Plugin can be distributed (<5MB)
3. **P1-1 complete** → ClaudeCodeAgent exists and works
4. **P1-5 passes** → Integration tests confirm end-to-end functionality

**Sprint is unsuccessful if:**

1. **P0-3 fails** → SDK requires subprocess (approach invalid)
2. **P0-1 fails** → SDK incompatible with Electron (approach invalid)
3. **P0-4 shows >5MB** → Bundle too large (may be salvageable with optimization)

**Comparison criteria** (after P1 completion):

- Does SDK version offer better UX than WandWithThinkingAgent?
- Is the complexity worth the benefit?
- Does SDK enable features not possible with direct API?
- Is maintenance burden acceptable?

---

## Blockers and Questions

### Pre-Implementation Questions

1. **CRITICAL**: Does `query()` work without Claude Code executable when using SDK MCP servers?
   - **Answer via**: P0-3 test
   - **Impact**: Entire approach viability

2. **HIGH**: Is bundle size acceptable?
   - **Answer via**: P0-4 measurement
   - **Impact**: Distribution feasibility

3. **MEDIUM**: Should we proceed if SDK isn't materially better than WandWithThinkingAgent?
   - **Answer via**: Comparison after P1
   - **Impact**: ROI on effort

### Open Questions

- Should sessions persist across plugin reloads?
- What's the optimal maxTurns value for Obsidian use cases?
- Should we expose SDK configuration in settings UI?
- How do we handle SDK updates (breaking changes)?

---

## Files to Create/Modify

### New Files (P0)
- `tests/agents/ClaudeSDKImport.test.ts` (P0-1)
- `tests/integration/mcp-server.test.ts` (P0-2)
- `tests/integration/sdk-query.test.ts` (P0-3)

### New Files (P1)
- `src/agents/ClaudeCodeAgent.ts` (P1-1)
- `src/agents/ClaudeCodeAgentFactory.ts` (P1-4)
- `tests/agents/ClaudeCodeAgent.test.ts` (P1-5)

### Modified Files (P1)
- `src/services/PluginServices.ts` (P1-4: register agent)
- `src/types/settings.ts` (P1-4: add AgentType)
- `src/main.ts` (P1-4: settings UI)

### Modified Files (P2)
- `src/views/ChatView.svelte` (P2-1: streaming UI)
- `src/types/settings.ts` (P2-3: system prompt setting)

---

## Definition of Done (Sprint)

This sprint is DONE when:

- [ ] All P0 items are complete with PASS/FAIL verdict documented
- [ ] Decision made: PROCEED to P1 or STOP and enhance WandWithThinkingAgent
- [ ] If PROCEED: P1-1 through P1-5 complete
- [ ] If PROCEED: Comparison vs WandWithThinkingAgent documented
- [ ] If STOP: Recommendations for WandWithThinkingAgent enhancement documented

**Deliverables**:
1. Test results for P0-1, P0-2, P0-3, P0-4
2. Decision gate verdict (PROCEED or STOP)
3. If PROCEED: Working ClaudeCodeAgent with tests
4. If STOP: Enhancement plan for WandWithThinkingAgent

---

## References

- **Status Report**: STATUS-2025-12-31-005911.md
- **Specification**: CLAUDE.md § Agent Architecture, ClaudeCodeAgent
- **Existing Code**:
  - `src/agents/ObsidianMCPServer.ts` (40+ tools already defined)
  - `src/agents/WandWithThinkingAgent.ts` (current knockoff implementation)
  - `src/agents/Agent.ts` (interface to implement)
- **SDK Docs**: `node_modules/@anthropic-ai/claude-agent-sdk/README.md`
- **SDK Types**: `node_modules/@anthropic-ai/claude-agent-sdk/entrypoints/agentSdkTypes.d.ts`
