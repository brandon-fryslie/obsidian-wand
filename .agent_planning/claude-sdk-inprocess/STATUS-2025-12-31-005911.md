# Status Report - 2025-12-31-005911
Scope: project/full
Confidence: FRESH

## Executive Summary
**Overall**: Integration is 15% complete - foundation exists but NOT functional
**Critical Issues**: 4 major blockers identified
**Tests Reliable**: No tests exist for SDK integration
**Verdict**: PAUSE - Requires architectural decisions before implementation

---

## Evaluation Summary

**SDK Available**: ✅ `@anthropic-ai/claude-agent-sdk@0.1.76` installed
**In-Process MCP**: ✅ `createSdkMcpServer()` function exists
**Tool Schemas Ready**: ✅ `ObsidianMCPServer.ts` has 40+ tools defined
**Current Implementation**: ❌ None - `WandWithThinkingAgent` is a knockoff using direct API calls

---

## Runtime Check Results

No runtime checks exist - this is a greenfield integration.

### Existing Checks (none applicable)
| Check Command | Purpose | Status |
|---------------|---------|--------|
| `pnpm test` | Unit tests | N/A - no SDK integration tests |
| Built plugin | Load in Obsidian | NOT TESTED - no SDK agent exists |

### Missing Checks (implementer should create)

1. **SDK Import Smoke Test** (`tests/agents/ClaudeAgentSDK.test.ts`)
   - Verify SDK imports in Obsidian plugin context
   - Test `createSdkMcpServer()` instantiation
   - Confirm tool registration works
   - **WHY**: SDK may have Node.js dependencies incompatible with Electron/browser

2. **In-Process MCP Server Test** (`tests/integration/mcp-server.test.ts`)
   - Create MCP server with 2-3 Obsidian tools
   - Verify tool handlers execute in plugin process
   - Confirm no subprocess spawning occurs
   - **WHY**: Core assumption - needs validation before full implementation

3. **SDK Query Test** (`tests/integration/sdk-query.test.ts`)
   - Call `query()` with in-process MCP server
   - Verify tools are available to Claude
   - Test tool execution and result handling
   - **WHY**: End-to-end validation of the integration concept

---

## Key Question: Does `createSdkMcpServer()` Actually Work In-Process?

### Evidence FOR (it might work):

**TypeScript Definition** (`entrypoints/agentSdkTypes.d.ts:677`):
```typescript
export declare function createSdkMcpServer(_options: CreateSdkMcpServerOptions): McpSdkServerConfigWithInstance;

type McpSdkServerConfigWithInstance = {
  type: 'sdk';
  name: string;
  instance: McpServer;  // ← Returns actual MCP server instance
};
```

**Implementation** (`sdk.mjs:26687-26706`):
```javascript
function createSdkMcpServer(options) {
  const server = new McpServer({ ... });
  if (options.tools) {
    options.tools.forEach((toolDef) => {
      server.tool(toolDef.name, toolDef.description,
                  toolDef.inputSchema, toolDef.handler);
    });
  }
  return { type: "sdk", name: options.name, instance: server };
}
```

**Documentation Comment** (`agentSdkTypes.d.ts:599-601`):
> "Supports both process-based servers (stdio, sse, http) and SDK servers (in-process).
> SDK servers are handled locally in the SDK process, while process-based servers
> are managed by the CLI subprocess."

**Existing Code** (`ObsidianMCPServer.ts:1-599`):
- Already uses `createSdkMcpServer()` with 40+ tools
- Tools call `toolsLayer.executeTool()` which works in-process
- Returns `McpSdkServerConfigWithInstance` correctly

### Evidence AGAINST (blockers exist):

**Blocker 1: Subprocess Spawning Still Required?**

The SDK has `pathToClaudeCodeExecutable` and `spawnClaudeCodeProcess` options. The question: Does `query()` REQUIRE spawning Claude Code even when using SDK servers?

From `agentSdkTypes.d.ts:1028-1043`:
```typescript
/**
 * Custom function to spawn the Claude Code process.
 * Use this to run Claude Code in VMs, containers, or remote environments.
 *
 * When provided, this function is called instead of the default local spawn.
 * The default behavior checks if the executable exists before spawning.
 */
spawnClaudeCodeProcess?: (options: SpawnOptions) => SpawnedProcess;
```

**CRITICAL AMBIGUITY**: Documentation says SDK servers are "handled locally in the SDK process" but doesn't confirm whether `query()` can run WITHOUT Claude Code subprocess.

**Blocker 2: Electron/Node.js Compatibility**

Obsidian runs in Electron (Chromium + Node.js hybrid). The SDK may use Node.js APIs unavailable or restricted in this environment:
- `child_process` for subprocess spawning
- `fs` with paths outside vault (sandboxed)
- Native modules (WebAssembly: `tree-sitter.wasm`, `resvg.wasm`)

**Evidence**: SDK has WebAssembly files (`tree-sitter-bash.wasm`, `tree-sitter.wasm`, `resvg.wasm`) which MAY work in Electron but need testing.

**Blocker 3: Bundle Size**

SDK package includes:
- Full Claude Code CLI (`cli.js`)
- MCP transport layer (`transport/`)
- WebAssembly modules
- Vendor libraries

**Impact**: Unknown if this bloats Obsidian plugin bundle beyond acceptable limits (Obsidian community plugins should be <5MB).

**Blocker 4: API Key Management**

SDK expects API keys via:
- Environment variables
- Settings files (`~/.claude/settings.json`)
- Options parameter

Obsidian plugins store settings in plugin data. **AMBIGUITY**: Can we pass API key purely via Options, or does SDK require Claude Code CLI infrastructure?

---

## Data Flow Verification

### Proposed Integration Flow

```
User Message → ClaudeSDKAgent.handleUserMessage()
             → query({ prompt, options: { mcpServers: { obsidian: sdkServer } } })
             → SDK calls tool via sdkServer.instance
             → Tool handler executes ToolsLayer.executeTool()
             → Result returned to SDK
             → SDK continues agent loop
             → Final response returned to agent
```

**Status**: ❌ NOT VERIFIED - theoretical only

| Flow Step | Input | Process | Store | Retrieve | Display |
|-----------|-------|---------|-------|----------|---------|
| User → SDK | ✅ String message | ❓ query() | - | - | - |
| SDK → Tool | ❓ Tool use | ❓ Handler call | - | - | - |
| Tool → Vault | ❓ Tool args | ❓ ToolsLayer | ❓ Obsidian API | - | - |
| Result → SDK | - | - | - | ❓ Tool result | - |
| SDK → User | - | - | - | - | ❓ Response text |

**Legend**: ✅ Verified | ❓ Unverified | ❌ Broken | - Not Applicable

---

## Ambiguities Found

| Area | Question | How Would Be Guessed | Impact |
|------|----------|---------------------|--------|
| **Subprocess Requirement** | Can `query()` run WITHOUT spawning Claude Code when using SDK MCP servers? | Assume yes based on "in-process" docs | **CRITICAL** - If no, entire approach fails in Obsidian |
| **API Key Passing** | Can API key be passed purely via Options, or does SDK need CLI config? | Try Options.apiKey (if exists) | **HIGH** - Blocks basic functionality |
| **Electron Compatibility** | Does SDK work in Electron renderer process? | Assume yes, bundle and test | **HIGH** - May fail at import time |
| **Bundle Strategy** | Should SDK be bundled with plugin or externalized? | Default esbuild behavior (bundle) | **MEDIUM** - Affects plugin size/load time |
| **Permission Callbacks** | How to integrate SDK permission system with Obsidian approval UI? | Use `canUseTool` callback | **MEDIUM** - Affects UX |
| **System Prompt** | Should we use SDK's default system prompt or custom? | Custom for Obsidian context | **LOW** - Tuning, not blocker |

---

## Implementation Assessment

| Component | Status | Confidence | Evidence | Issues |
|-----------|--------|------------|----------|--------|
| **SDK Installation** | COMPLETE | FRESH | package.json:59 | None |
| **MCP Server Creation** | COMPLETE | FRESH | ObsidianMCPServer.ts:1-599 | None - already works |
| **Tool Definitions** | COMPLETE | FRESH | 40+ tools with schemas | None |
| **SDK Agent Class** | NOT_STARTED | N/A | - | Blocked by ambiguities |
| **Permission Integration** | NOT_STARTED | N/A | - | Depends on SDK agent |
| **Testing Infrastructure** | NOT_STARTED | N/A | - | No tests planned yet |

---

## Minimum Viable Integration (if subprocess NOT required)

**Assumption**: `query()` works with SDK MCP servers without spawning Claude Code.

### Phase 1: Proof of Concept (1-2 hours)
1. Create `ClaudeSDKAgent` class implementing `Agent` interface
2. Import SDK: `import { query, createSdkMcpServer, tool } from '@anthropic-ai/claude-agent-sdk'`
3. Create MCP server with 3 basic tools (readFile, listFiles, searchText)
4. Call `query()` with:
   ```typescript
   const result = await query({
     prompt: userMessage,
     options: {
       model: 'claude-sonnet-4-5-20250929',
       mcpServers: {
         obsidian: createSdkMcpServer({
           name: 'obsidian-vault',
           version: '1.0.0',
           tools: [/* 3 tools */]
         })
       },
       maxTurns: 10,
       permissionMode: 'acceptEdits', // or custom canUseTool
     }
   });
   ```
5. Stream results and return to UI

**Expected Outcome**: Either works (proves concept) or fails (reveals actual blocker).

### Phase 2: Full Integration (if Phase 1 succeeds)
1. Wire all 40+ tools from `ObsidianMCPServer.ts`
2. Implement permission callback mapping to Obsidian approval UI
3. Add state management (thinking/executing/idle)
4. Add abort controller support
5. Create tests

### Phase 3: Polish (if Phase 2 works)
1. Optimize bundle size (externalize SDK if needed)
2. Add error handling and retry logic
3. Implement session management if desired
4. Add configuration options (system prompt, model selection)

---

## Reusable Knowledge Discovered

**Architecture Pattern**: The SDK expects MCP servers to provide tools, and it orchestrates the agent loop (thinking → tool use → results → repeat). Our role is just to:
1. Provide tools via `createSdkMcpServer()`
2. Stream events from `query()`
3. Handle permission requests via `canUseTool` callback

**Tool Handler Signature**:
```typescript
handler: (args: z.infer<ZodObject<Schema>>, extra: unknown) => Promise<CallToolResult>
```
Returns `CallToolResult` which is MCP format: `{ content: [{ type: "text", text: string }] }`

**Existing Code Reuse**: `ObsidianMCPServer.ts` already has the correct format - just need to pass it to SDK instead of exposing for external MCP clients.

---

## Risks & Blockers

### CRITICAL RISKS

1. **SDK Requires Claude Code Subprocess**
   - **Probability**: 60% (docs suggest SDK servers are in-process, but unclear)
   - **Impact**: KILLS entire approach - must use direct Anthropic API like `WandWithThinkingAgent`
   - **Mitigation**: Test immediately with Phase 1 POC
   - **Fallback**: Keep `WandWithThinkingAgent`, enhance with better prompt engineering

2. **Electron Incompatibility**
   - **Probability**: 30% (Node.js APIs may be restricted)
   - **Impact**: HIGH - blocks SDK usage entirely
   - **Mitigation**: Test imports early, check esbuild external config
   - **Fallback**: Same as #1

3. **Bundle Size Explosion**
   - **Probability**: 50% (SDK includes full CLI)
   - **Impact**: MEDIUM - plugin too large for Obsidian community
   - **Mitigation**: Externalize SDK, lazy load, or tree-shake
   - **Fallback**: Direct API approach

### MEDIUM RISKS

4. **Permission System Mismatch**
   - **Probability**: 40%
   - **Impact**: MEDIUM - poor UX, requires custom implementation
   - **Mitigation**: Use `canUseTool` callback, map to existing approval service

5. **API Key Configuration**
   - **Probability**: 20%
   - **Impact**: MEDIUM - users confused about setup
   - **Mitigation**: Store in plugin settings, pass via Options

---

## Recommendations

### IMMEDIATE (before any coding):

1. **Run Phase 1 POC** (2 hours max)
   - Create minimal `ClaudeSDKAgent.ts`
   - Import SDK and test `query()` with SDK MCP server
   - Document exact error if it fails
   - **Decision Point**: If subprocess required → STOP, enhance WandWithThinkingAgent instead

2. **Test Bundle Size**
   - Build plugin with SDK imported
   - Check output size vs. current (~500KB currently)
   - If >5MB → investigate externalization

3. **Test Electron Compatibility**
   - Import SDK in Obsidian plugin context
   - Check for runtime errors (require/import failures)
   - Test WebAssembly module loading

### IF POC SUCCEEDS:

4. **Implement Full Agent** (4-8 hours)
   - Wire all tools from `ObsidianMCPServer.ts`
   - Add permission callback
   - Implement streaming UI updates
   - Add tests

5. **Compare vs WandWithThinkingAgent**
   - Feature parity check
   - Performance comparison
   - UX comparison
   - **Decision**: Keep SDK version ONLY if materially better

### IF POC FAILS:

6. **Enhance WandWithThinkingAgent**
   - Improve system prompt (study Claude Code prompts)
   - Add better error handling
   - Implement file editing improvements
   - Add caching for repeated tool calls
   - **Accept**: We have a working "knockoff" that's good enough

---

## Workflow Recommendation

**[X] PAUSE** - Ambiguities need clarification before proceeding

### Critical Questions for User/Research:

1. **Does `query()` work without Claude Code subprocess when using SDK MCP servers?**
   - **How to find out**: Run Phase 1 POC
   - **Impact**: Determines if approach is viable

2. **What's the bundle size impact?**
   - **How to find out**: Import SDK, build, check dist size
   - **Impact**: Determines if plugin is distributable

3. **Does SDK work in Electron renderer process?**
   - **How to find out**: Test import in Obsidian dev mode
   - **Impact**: Determines basic compatibility

4. **What's better: Real SDK vs. our knockoff?**
   - **How to find out**: Compare features, UX, complexity
   - **Impact**: Determines if effort is worth it

---

## Next Steps

**Recommended Sequence**:

1. **Validate Core Assumption** (30 min)
   ```bash
   # Create minimal test file
   # Import SDK, call query() with SDK MCP server
   # Does it work or demand Claude Code executable?
   ```

2. **IF Step 1 Works** → Implement Phase 1 POC (2 hours)

3. **IF Step 2 Works** → Run full comparison vs WandWithThinkingAgent (1 hour)

4. **IF Step 3 Positive** → Implement Phase 2 (8 hours)

5. **ELSE** → Enhance WandWithThinkingAgent with lessons learned

**Total Risk Window**: 3-4 hours to prove/disprove viability before major time investment.

---

## Technical Notes

### SDK Version
- Installed: `@anthropic-ai/claude-agent-sdk@0.1.76`
- Latest: Check npm (was @0.1.14 in package.json, now @0.1.76 actual)
- **Note**: Package version mismatch - package.json says 0.1.14, node_modules has 0.1.76

### Import Strategy
```typescript
// ESM import (SDK is type: "module")
import { query, createSdkMcpServer, tool } from '@anthropic-ai/claude-agent-sdk';

// For esbuild in Obsidian plugin
// May need: external: ['@anthropic-ai/claude-agent-sdk']
// Or: bundle with proper Node.js polyfills
```

### Tool Handler Template
```typescript
const toolDef = tool(
  "vault_readFile",
  "Read a file from the vault",
  { path: z.string() },
  async (args, extra) => {
    const result = await toolsLayer.executeTool("vault.readFile", args, context);
    return {
      content: [{ type: "text", text: JSON.stringify(result, null, 2) }]
    };
  }
);
```

---

## Files Examined

- `/Users/bmf/code/obsidian-toolagent/package.json` (SDK dependency)
- `/Users/bmf/code/obsidian-toolagent/src/agents/ObsidianMCPServer.ts` (Existing MCP server with 40+ tools)
- `/Users/bmf/code/obsidian-toolagent/src/agents/WandWithThinkingAgent.ts` (Current "knockoff" implementation)
- `/Users/bmf/code/obsidian-toolagent/node_modules/@anthropic-ai/claude-agent-sdk/entrypoints/agentSdkTypes.d.ts` (SDK TypeScript definitions)
- `/Users/bmf/code/obsidian-toolagent/node_modules/@anthropic-ai/claude-agent-sdk/sdk.mjs` (SDK implementation)
- `/Users/bmf/code/obsidian-toolagent/node_modules/@anthropic-ai/claude-agent-sdk/README.md` (SDK documentation)

---

**Git Commit**: f46dc13
**Evaluator**: project-evaluator
**Timestamp**: 2025-12-31 00:59:11
