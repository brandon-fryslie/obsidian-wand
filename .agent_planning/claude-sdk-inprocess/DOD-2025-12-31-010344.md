# Definition of Done: Claude SDK In-Process Validation

**Generated**: 2025-12-31-010344
**Plan**: PLAN-2025-12-31-010344.md
**Type**: Validation Sprint (Fail-Fast)

---

## Sprint Scope

This sprint delivers: **Validation of SDK approach viability + minimal working integration (if viable)**

**Deferred**: Streaming UI, session management, custom prompts, optimization (P2/P3 items)

---

## Acceptance Criteria

### Phase 1: Validation (MUST COMPLETE FIRST)

#### P0-1: SDK Import Compatibility

- [ ] Test file `tests/agents/ClaudeSDKImport.test.ts` exists and imports SDK without errors
- [ ] `import { query, createSdkMcpServer } from '@anthropic-ai/claude-agent-sdk'` succeeds
- [ ] WebAssembly modules (tree-sitter.wasm, resvg.wasm) are accessible
- [ ] esbuild configuration documented (external/bundle/polyfills)
- [ ] Test passes in Obsidian plugin environment

#### P0-2: In-Process MCP Server Instantiation

- [ ] MCP server created via `createSdkMcpServer()` with 3 tools: readFile, listFiles, searchText
- [ ] Return value is `McpSdkServerConfigWithInstance` with non-null `instance` property
- [ ] Tool handlers execute successfully and return MCP format: `{ content: [{ type: "text", text: "..." }] }`
- [ ] NO subprocess spawning detected (verified via process monitoring or absence of child_process calls)
- [ ] Server configuration documented in test file

#### P0-3: SDK Query Without Subprocess

- [ ] `query()` called with: `{ prompt, options: { model, mcpServers: { obsidian: sdkServer }, maxTurns: 10, apiKey } }`
- [ ] Query executes WITHOUT requiring Claude Code executable
- [ ] Tools from MCP server are invoked during agent loop
- [ ] Tool execution results are returned to SDK and used in response
- [ ] Final response is returned successfully
- [ ] Exact working options configuration documented

**DECISION GATE**: If P0-3 FAILS → Document failure mode and STOP. Recommend enhancing WandWithThinkingAgent.

#### P0-4: Bundle Size Impact

- [ ] Baseline bundle size measured (build without SDK)
- [ ] SDK imported in plugin code
- [ ] New bundle size measured (build with SDK)
- [ ] Size increase calculated and documented
- [ ] Recommendation documented: bundle vs external vs abandon (if >5MB, flag for investigation)

---

### Phase 2: Integration (ONLY IF P0 SUCCEEDS)

#### P1-1: ClaudeCodeAgent Class

- [ ] File `src/agents/ClaudeCodeAgent.ts` exists and implements Agent interface
- [ ] Constructor accepts `AgentDependencies` (apiKey, toolsLayer, settings)
- [ ] `handleUserMessage()` calls SDK `query()` with user prompt and MCP server
- [ ] State transitions: idle → thinking (during query) → idle
- [ ] Abort functionality works via AbortController
- [ ] State updates emitted via `onStateChange` callback
- [ ] Returns AgentResponse with type "message" for success
- [ ] Returns AgentResponse with type "error" for failures

#### P1-2: Wire All Obsidian MCP Tools

- [ ] All 40+ tools from `ObsidianMCPServer.ts` registered with `createSdkMcpServer()`
- [ ] Tool handlers call `toolsLayer.executeTool(toolName, args, context)` correctly
- [ ] Tool results converted to MCP format: `{ content: [{ type: "text", text: JSON.stringify(result) }] }`
- [ ] 5 representative tools tested successfully:
  - [ ] `vault_readFile` (read-only)
  - [ ] `vault_createFile` (write)
  - [ ] `dataview_query` (plugin integration)
  - [ ] `editor_getSelection` (editor)
  - [ ] `workspace_getContext` (workspace)
- [ ] All tested tools execute in-process without subprocess spawning

#### P1-3: Permission Integration

- [ ] `canUseTool` callback implemented in query options: `async (toolName, args) => Promise<boolean>`
- [ ] Callback uses `ApprovalService.checkApproval()` to determine approval needed
- [ ] High-risk tools (writeFile, delete, rename, commands.run) trigger approval UI
- [ ] Safe tools (readFile, listFiles, searchText) auto-approve
- [ ] User can approve/deny via existing approval modal
- [ ] Approval/denial correctly controls tool execution (denied = false returned to SDK)
- [ ] High-risk tool test (vault_writeFile) triggers modal and respects user choice

#### P1-4: Agent Registration and Settings

- [ ] File `src/agents/ClaudeCodeAgentFactory.ts` exists and implements AgentFactory
- [ ] Factory registered in `PluginServices.ts`: `agentRegistry.register("claude-code", new ClaudeCodeAgentFactory())`
- [ ] "claude-code" added to AgentType union in `types/settings.ts`
- [ ] Settings dropdown in `main.ts` includes: "Claude Code Agent - Full autonomous agent with SDK"
- [ ] Test: Selecting agent in settings creates ClaudeCodeAgent instance
- [ ] Agent appears in agent list with correct name and description

#### P1-5: Basic Integration Tests

- [ ] File `tests/agents/ClaudeCodeAgent.test.ts` exists with test suite
- [ ] Test: Agent initializes successfully with mock dependencies (PASS)
- [ ] Test: `handleUserMessage()` calls SDK query and returns response (PASS)
- [ ] Test: Tools are executed during agent loop (mocked handlers verify calls) (PASS)
- [ ] Test: State transitions correctly (idle → thinking → idle) (PASS)
- [ ] Test: Abort functionality works (abortController stops query) (PASS)
- [ ] Test: Error handling returns AgentResponse with type "error" (PASS)
- [ ] All tests pass with 100% success rate

---

## Sprint Success Criteria

**Sprint is SUCCESSFUL if:**

1. **All P0 items PASS** → SDK works in Electron without subprocess (approach is viable)
2. **Bundle size <5MB** → Plugin can be distributed
3. **All P1 items COMPLETE** → ClaudeCodeAgent exists and works end-to-end
4. **Integration tests PASS** → Functionality verified

**Sprint is UNSUCCESSFUL if:**

1. **P0-3 FAILS** → SDK requires subprocess (entire approach invalid)
2. **P0-1 FAILS** → SDK incompatible with Electron (entire approach invalid)
3. **P0-4 shows >5MB AND optimization not feasible** → Bundle too large (may require abandoning)

---

## Deliverables

### Required Deliverables (P0)

1. **Test Results Document**:
   - P0-1: SDK import test results (PASS/FAIL + errors if any)
   - P0-2: MCP server instantiation test results (PASS/FAIL)
   - P0-3: Query test results (PASS/FAIL + subprocess detection method)
   - P0-4: Bundle size measurements (baseline, with SDK, delta, %)

2. **Decision Gate Verdict**:
   - PROCEED to P1 (if P0 passes) OR
   - STOP and enhance WandWithThinkingAgent (if P0 fails)
   - Rationale for decision

### Required Deliverables (P1) - IF PROCEED

3. **Working Implementation**:
   - `src/agents/ClaudeCodeAgent.ts`
   - `src/agents/ClaudeCodeAgentFactory.ts`
   - Agent registered and selectable in settings

4. **Test Suite**:
   - `tests/agents/ClaudeCodeAgent.test.ts` (all tests passing)
   - `tests/agents/ClaudeSDKImport.test.ts` (validation test)

5. **Comparison Document** (brief):
   - ClaudeCodeAgent vs WandWithThinkingAgent
   - Feature parity check
   - UX comparison
   - Recommendation: keep SDK version or revert to knockoff

### Optional Deliverables (IF STOP)

6. **WandWithThinkingAgent Enhancement Plan**:
   - Lessons learned from SDK investigation
   - Recommended improvements to knockoff implementation
   - Prioritized enhancement backlog

---

## Out of Scope (Explicitly Deferred)

The following are **NOT** part of this sprint:

- [ ] Streaming UI updates (P2-1) - Deferred to next sprint
- [ ] Session management (P2-2) - Deferred to next sprint
- [ ] Custom system prompt (P2-3) - Deferred to next sprint
- [ ] Bundle size optimization (P3-1) - Deferred unless P0-4 shows critical issue
- [ ] Advanced error handling/retry (P3-2) - Deferred to next sprint
- [ ] Full 40+ tool testing - Only 5 representative tools tested in P1-2
- [ ] Performance benchmarking - Not measured in this sprint
- [ ] Production readiness - This is validation sprint, not production release

---

## Validation Checklist (Use This to Track Sprint Progress)

### Phase 1: Validation

- [ ] P0-1: SDK imports successfully in Obsidian plugin
- [ ] P0-2: MCP server instantiates without subprocess
- [ ] P0-3: `query()` works with SDK MCP server (NO subprocess)
- [ ] P0-4: Bundle size measured and acceptable (<5MB)
- [ ] **DECISION**: Proceed to P1 or Stop?

### Phase 2: Integration (if proceeded)

- [ ] P1-1: ClaudeCodeAgent class implemented
- [ ] P1-2: All 40+ tools wired, 5 tested successfully
- [ ] P1-3: Permission integration working
- [ ] P1-4: Agent registered and selectable
- [ ] P1-5: Integration tests passing

### Final Deliverables

- [ ] Test results documented
- [ ] Decision gate verdict recorded
- [ ] Working implementation (if proceeded) or enhancement plan (if stopped)
- [ ] Comparison vs WandWithThinkingAgent completed

---

## Notes

- This is a **validation sprint** - emphasis on proving/disproving the approach quickly
- **Fail fast**: If P0 fails, stop immediately and document why
- **Time-boxed**: P0 should take 2-3 hours max. If exceeding, reassess approach.
- **Decision-driven**: Every P0 item has clear pass/fail criteria
- **Pragmatic**: If SDK isn't better than WandWithThinkingAgent after P1, recommend keeping the knockoff
