# Sprint Plan: Agent API Boundary (Revised)

**Generated**: 2025-12-27-183800
**Revision of**: PLAN-2025-12-27-183215.md
**Sprint Goal**: Create a clean Agent API boundary between agent logic and plugin infrastructure

---

## Executive Summary

### Objective
Define and implement a clean Agent API that separates agent-specific logic (prompts, planning, response generation) from plugin infrastructure (settings, services, UI). This is a foundational refactor - no backward compatibility constraints.

### Primary Deliverable
A well-defined `Agent` interface that:
- Encapsulates all agent-specific behavior
- Can be implemented by different agent types
- Provides a clear contract between agents and the plugin

### Constraints (Simplified)
- **No backward compatibility required** - Breaking changes are acceptable
- **No feature flags** - Direct refactoring
- **No migration logic** - Fresh settings structure
- **Future work**: Tools API refinement is explicitly out of scope

---

## Work Items

### P0-1: Define Agent Interface (PRIMARY)

**Effort**: 2-3 days
**Dependencies**: None

Create `src/agents/Agent.ts` with:

```typescript
export interface Agent {
  // Lifecycle
  initialize(): Promise<void>;
  cleanup(): void;

  // Core functionality
  handleUserMessage(message: string, context: AgentContext): Promise<AgentResponse>;
  abort(): void;

  // Metadata
  getName(): string;
  getDescription(): string;

  // State
  getState(): AgentState;
  onStateChange(callback: (state: AgentState) => void): void;
}

export interface AgentContext {
  activeFile?: string;
  selection?: string;
  vaultPath: string;
}

export interface AgentResponse {
  type: 'plan' | 'message' | 'error';
  plan?: ActionPlan;
  message?: string;
  error?: string;
}

export interface AgentState {
  status: 'idle' | 'thinking' | 'executing' | 'error';
  currentPlan?: ActionPlan;
  lastError?: string;
}

export interface AgentDependencies {
  app: App;
  settings: ToolAgentSettings;
  llmProvider: LLMProvider;
  executor: Executor;
  toolsLayer: ToolsLayer;
  approvalService: ApprovalService;
}
```

**Acceptance Criteria**:
- [ ] Interface defined with clear method contracts
- [ ] Types exported for use by implementations
- [ ] JSDoc comments on all methods explaining expected behavior
- [ ] TypeScript compiles

---

### P0-2: Implement WandAgent (PRIMARY)

**Effort**: 1 week
**Dependencies**: P0-1

Extract current ChatController logic into `src/agents/WandAgent.ts`:

**Moves to WandAgent**:
- `buildSystemPrompt()` (currently lines 731-831)
- `buildUserPrompt()` (lines 833-851)
- `generatePlanWithRetry()` (lines 523-639)
- `executeReadOnlySteps()` (lines 641-682)
- `buildResolutionPrompt()` (lines 684-729)
- `formatPlanResponse()` (lines 853-889)
- `formatError()` (lines 486-521)

**WandAgent responsibilities**:
- Owns all prompt building
- Handles plan generation and retry logic
- Manages placeholder resolution
- Formats responses for display

**Acceptance Criteria**:
- [ ] WandAgent implements Agent interface
- [ ] All prompt/planning logic moved from ChatController
- [ ] WandAgent can generate plans independently
- [ ] State transitions work: idle → thinking → idle
- [ ] abort() cancels in-progress generation

---

### P0-3: Refactor ChatController to Use Agent API (PRIMARY)

**Effort**: 3-4 days
**Dependencies**: P0-2

ChatController becomes thin orchestrator:

**Keeps**:
- Message history management
- State change callback management
- Execution orchestration (calls Executor)
- Approval flow coordination

**Removes**:
- All prompt building code
- Plan generation logic
- Placeholder resolution
- Error formatting

**New flow**:
```typescript
async sendMessage(message: string): Promise<void> {
  const context = this.gatherContext();
  const response = await this.agent.handleUserMessage(message, context);

  if (response.type === 'plan') {
    // Handle plan approval and execution
  } else if (response.type === 'error') {
    // Display error
  }
}
```

**Acceptance Criteria**:
- [ ] ChatController delegates to Agent for message handling
- [ ] ChatController reduced significantly (target: <300 lines, was 929)
- [ ] Clear separation: Agent = plan generation, ChatController = orchestration
- [ ] Plugin functions correctly with new structure

---

### P0-4: Agent Selection in Settings (SECONDARY)

**Effort**: 2-3 days
**Dependencies**: P0-1

Add agent type selection:

**Settings changes** (`src/types/settings.ts`):
```typescript
export interface ToolAgentSettings {
  agent: {
    type: 'wand';  // Extensible union type
  };
  llm: { ... };
  approval: { ... };
  chat: { ... };
}
```

**UI changes** (`src/main.ts`):
- Add "Agent Type" dropdown at top of settings
- Single option: "Wand Agent - Plan-based automation"

**Acceptance Criteria**:
- [ ] Settings include `agent.type` field
- [ ] UI dropdown for agent selection
- [ ] Setting persists across plugin reload

---

### P0-5: Agent Registry/Factory (SECONDARY)

**Effort**: 2 days
**Dependencies**: P0-2, P0-4

Create `src/agents/AgentRegistry.ts`:

```typescript
export interface AgentFactory {
  create(deps: AgentDependencies): Agent;
  getInfo(): AgentInfo;
}

export interface AgentInfo {
  type: string;
  name: string;
  description: string;
}

export class AgentRegistry {
  register(type: string, factory: AgentFactory): void;
  create(type: string, deps: AgentDependencies): Agent;
  list(): AgentInfo[];
  has(type: string): boolean;
}
```

**PluginServices changes**:
```typescript
// Old
this.chatController = new ChatController(...);

// New
this.registry = new AgentRegistry();
this.registry.register('wand', new WandAgentFactory());
const agent = this.registry.create(settings.agent.type, deps);
this.chatController = new ChatController(agent, ...);
```

**Acceptance Criteria**:
- [ ] Registry pattern implemented
- [ ] WandAgentFactory creates WandAgent instances
- [ ] PluginServices uses registry for agent creation
- [ ] Unknown agent type throws clear error

---

### P1-1: Basic Tests (SECONDARY)

**Effort**: 2-3 days
**Dependencies**: P0-2, P0-5

Write tests for new agent infrastructure:

- `tests/agents/WandAgent.test.ts` - Core functionality
- `tests/agents/AgentRegistry.test.ts` - Registry operations

Focus on:
- Agent implements interface correctly
- Plan generation works
- State transitions work
- Registry creates agents

**Acceptance Criteria**:
- [ ] WandAgent tests pass
- [ ] Registry tests pass
- [ ] `pnpm run test` succeeds

---

### P1-2: Update Documentation (SECONDARY)

**Effort**: 1 day
**Dependencies**: All P0 items

Update CLAUDE.md with:
- New Agent Architecture section
- Agent interface documentation
- How to add a new agent type

**Acceptance Criteria**:
- [ ] CLAUDE.md reflects new architecture
- [ ] Agent interface documented
- [ ] Clear instructions for adding agents

---

## Files to Create/Modify

**New Files**:
```
src/agents/
├── Agent.ts           # Interface and types
├── WandAgent.ts       # Wand implementation
├── AgentRegistry.ts   # Registry and factory types
└── WandAgentFactory.ts
tests/agents/
├── WandAgent.test.ts
└── AgentRegistry.test.ts
```

**Modified Files**:
```
src/services/ChatController.ts  # Refactor to use Agent
src/services/PluginServices.ts  # Use registry
src/types/settings.ts           # Add agent section
src/main.ts                     # Add settings UI
CLAUDE.md                       # Update docs
```

---

## Timeline

**Week 1**: Foundation
- Days 1-2: P0-1 (Agent interface)
- Days 3-5: P0-2 (WandAgent) - start extraction

**Week 2**: Integration
- Days 1-2: P0-2 (WandAgent) - complete
- Days 3-4: P0-3 (ChatController refactor)
- Day 5: P0-4 (Settings) + P0-5 (Registry)

**Week 3**: Polish
- Days 1-2: P1-1 (Tests)
- Day 3: P1-2 (Documentation)
- Days 4-5: Buffer / refinement

---

## Definition of Done

**Sprint is complete when**:
1. [ ] Agent interface exists and is well-documented
2. [ ] WandAgent implements interface with all current functionality
3. [ ] ChatController delegates to Agent (significantly smaller)
4. [ ] Settings include agent type dropdown
5. [ ] Registry creates agents via factory pattern
6. [ ] Plugin loads and works with new architecture
7. [ ] Basic tests pass
8. [ ] CLAUDE.md updated

**Validation**:
```bash
pnpm run typecheck  # Compiles
pnpm run test       # Tests pass
pnpm run build      # Builds
just setup && just obsidian  # Plugin works
```

---

## Future Work (Out of Scope)

- **Tools API refinement** - Explicitly deferred per user guidance
- **Additional agent implementations** - This sprint only creates infrastructure
- **Agent auto-routing** - Manual selection only
- **Per-agent LLM config** - Shared provider for now
