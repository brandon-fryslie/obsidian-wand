# Definition of Done: Agent API Boundary (Revised)

**Generated**: 2025-12-27-183800
**Plan**: PLAN-2025-12-27-183800-REVISED.md
**Sprint Goal**: Create a clean Agent API boundary between agent logic and plugin infrastructure

---

## Sprint Scope

This sprint delivers a **clean Agent API** separating:
- Agent-specific logic (prompts, planning, response generation)
- Plugin infrastructure (settings, services, UI)

**No backward compatibility constraints. Breaking changes are acceptable.**

---

## P0-1: Define Agent Interface

### Acceptance Criteria
- [ ] `src/agents/Agent.ts` exports `Agent` interface with methods:
  - `initialize(): Promise<void>`
  - `handleUserMessage(message: string, context: AgentContext): Promise<AgentResponse>`
  - `cleanup(): void`
  - `abort(): void`
  - `getName(): string`
  - `getDescription(): string`
  - `getState(): AgentState`
  - `onStateChange(callback: (state: AgentState) => void): void`
- [ ] `AgentContext` type defined: `activeFile`, `selection`, `vaultPath`
- [ ] `AgentResponse` type defined: `type`, `plan?`, `message?`, `error?`
- [ ] `AgentState` type defined: `status`, `currentPlan?`, `lastError?`
- [ ] `AgentDependencies` interface defined with all common services
- [ ] JSDoc comments explain each method's contract
- [ ] TypeScript compiles (`pnpm run typecheck`)

---

## P0-2: Implement WandAgent

### Acceptance Criteria
- [ ] `src/agents/WandAgent.ts` implements `Agent` interface
- [ ] WandAgent contains extracted methods:
  - `buildSystemPrompt()`
  - `buildUserPrompt()`
  - `generatePlanWithRetry()`
  - `executeReadOnlySteps()`
  - `buildResolutionPrompt()`
  - `formatPlanResponse()`
  - `formatError()`
- [ ] WandAgent handles full plan generation lifecycle
- [ ] State transitions: idle → thinking → idle
- [ ] `abort()` cancels in-progress LLM calls
- [ ] TypeScript compiles

---

## P0-3: Refactor ChatController to Use Agent API

### Acceptance Criteria
- [ ] ChatController accepts Agent via constructor/dependency
- [ ] `sendMessage()` delegates to `agent.handleUserMessage()`
- [ ] ChatController handles:
  - Message history
  - Approval flow coordination
  - Execution orchestration
- [ ] ChatController does NOT contain:
  - Prompt building
  - Plan generation logic
  - Placeholder resolution
- [ ] ChatController reduced to <300 lines (from 929)
- [ ] Plugin functions correctly

---

## P0-4: Agent Selection in Settings

### Acceptance Criteria
- [ ] `src/types/settings.ts` includes `agent.type` field
- [ ] Settings UI has "Agent Type" dropdown
- [ ] Dropdown has "Wand Agent" option
- [ ] Setting persists across reload
- [ ] TypeScript compiles

---

## P0-5: Agent Registry/Factory

### Acceptance Criteria
- [ ] `src/agents/AgentRegistry.ts` with methods:
  - `register(type, factory)`
  - `create(type, deps)`
  - `list()`
  - `has(type)`
- [ ] `AgentFactory` interface with `create()` and `getInfo()`
- [ ] `WandAgentFactory` implemented
- [ ] PluginServices uses registry for agent creation
- [ ] Unknown agent type throws descriptive error
- [ ] TypeScript compiles

---

## P1-1: Basic Tests

### Acceptance Criteria
- [ ] `tests/agents/WandAgent.test.ts` exists
- [ ] `tests/agents/AgentRegistry.test.ts` exists
- [ ] WandAgent tests: initialization, message handling, state transitions
- [ ] Registry tests: register, create, list, error handling
- [ ] `pnpm run test` passes

---

## P1-2: Update Documentation

### Acceptance Criteria
- [ ] CLAUDE.md has "Agent Architecture" section
- [ ] Agent interface signature documented
- [ ] Instructions for adding new agent type
- [ ] ChatController's new role explained

---

## Sprint-Level Success Criteria

### Core (Must Have)
- [ ] Agent interface exists and is documented
- [ ] WandAgent implements interface with all functionality
- [ ] ChatController delegates to Agent
- [ ] Plugin loads and works

### Quality (Must Have)
- [ ] TypeScript compiles: `pnpm run typecheck`
- [ ] Tests pass: `pnpm run test`
- [ ] Build succeeds: `pnpm run build`

### Code Quality (Must Have)
- [ ] Clear separation: Agent owns planning, ChatController owns orchestration
- [ ] ChatController <300 lines
- [ ] Adding a new agent would require only:
  - Implement Agent interface
  - Create factory
  - Register in PluginServices
  - Add settings option

---

## Validation Checklist

```bash
# Must all pass before sprint complete
pnpm run typecheck
pnpm run test
pnpm run build
just setup && just obsidian  # Manual: plugin works
```

---

## Sprint Complete When

1. **P0 items all done** (P0-1 through P0-5)
2. **P1 items all done** (P1-1 through P1-2)
3. **Validation checklist passes**
4. **Plugin works with new architecture**

---

## Out of Scope (Future Work)

- Tools API refinement
- Additional agent implementations
- Agent auto-routing
- Per-agent LLM configuration
- Backward compatibility or migration
