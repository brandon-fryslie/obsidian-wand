# Sprint Plan: Claude Code via Sidecar Subprocess

Generated: 2025-12-31

## Sprint Goal

Run the Claude Agent SDK as a subprocess spawned by the Obsidian plugin, giving users full Claude Code capabilities within Obsidian.

## Context

This is **Option 2** - the plugin spawns Claude Code as a subprocess.

**How it differs from other options:**
- Option 1 (In-process): SDK runs in same process, uses `createSdkMcpServer()` for tools
- Option 2 (This): Plugin spawns Claude Code CLI, communicates via IPC/stdio
- Option 3 (MCP Server): External Claude Code connects to plugin's MCP server

**Why this approach:**
- SDK is designed for subprocess spawning
- Many Obsidian plugins successfully spawn subprocesses (Git, Pandoc, terminal)
- Full Claude Code capabilities (bash, file system, etc.)
- Plugin controls the Claude Code instance lifecycle

## Scope

**In scope (this sprint):**
1. P0: Subprocess spawning infrastructure
2. P1: IPC communication layer
3. P1: Obsidian tools exposed via MCP to subprocess

**Explicitly out of scope (future sprints):**
- Streaming UI integration
- Session persistence
- Custom system prompts
- Cross-platform packaging (assumes user has Node.js)

## Work Items

### P0-1: Subprocess Spawning Infrastructure (4-6 hours)

**Acceptance Criteria:**
- [ ] Plugin can spawn Claude Code CLI via `child_process`
- [ ] Subprocess lifecycle management (start, stop, restart)
- [ ] Graceful shutdown on plugin unload
- [ ] Error handling for spawn failures
- [ ] Cross-platform path resolution (Windows/Mac/Linux)

**Technical Notes:**
- Use `child_process.spawn()` with stdio: 'pipe'
- SDK provides `pathToClaudeCodeExecutable` option
- May need to bundle or reference global Claude Code installation
- Reference obsidian-git for subprocess patterns

### P1-1: IPC Communication Layer (3-4 hours)

**Acceptance Criteria:**
- [ ] Plugin sends messages to subprocess via stdin
- [ ] Plugin receives responses via stdout
- [ ] JSON-RPC or similar protocol for structured communication
- [ ] Timeout handling for unresponsive subprocess
- [ ] Buffer handling for large responses

**Technical Notes:**
- Use line-delimited JSON for simplicity
- Consider using SDK's built-in message protocol if available
- Handle partial reads and message boundaries

### P1-2: Expose Obsidian Tools to Subprocess (4-6 hours)

**Acceptance Criteria:**
- [ ] Subprocess can call Obsidian vault tools
- [ ] Tool results returned to subprocess
- [ ] Error handling for failed tool calls
- [ ] At least 5 core tools working (read, write, list, search, open)

**Technical Notes:**
- Can reuse ObsidianMCPServer.ts tool definitions
- Need to implement tool call routing from subprocess to plugin
- May use MCP protocol or custom protocol

## Dependencies

- Claude Agent SDK installed (`@anthropic-ai/claude-agent-sdk`)
- Understanding of SDK's subprocess spawning mechanism
- Option 1 POC results (may inform this approach)

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| SDK bundling complications | 40% | Medium | Use global installation as fallback |
| Cross-platform issues | 30% | Medium | Test on all platforms early |
| IPC complexity | 20% | Medium | Start with simple stdio protocol |
| Bundle size | 50% | Low | SDK in subprocess, not bundled |

## Effort Estimate

- P0-1: 4-6 hours
- P1-1: 3-4 hours
- P1-2: 4-6 hours
- **Total: 11-16 hours**

## Decision Point

If Option 1 (in-process SDK) works well, this option may be deprioritized.
If Option 1 fails, this becomes the primary path forward.
