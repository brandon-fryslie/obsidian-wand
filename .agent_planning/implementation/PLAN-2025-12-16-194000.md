# Sprint Plan: Plan Preview & LLM Integration (M3-M4)

Generated: 2025-12-16-194000

## Sprint Goal

Complete the user-facing workflow: generate plans from LLM, validate them, display human-readable previews, and enable user confirmation before execution.

## Current State

**Completed (M1-M2):**
- TypeScript compiles (0 errors)
- All 18 tools implemented with Zod schemas
- PlanValidator validates plans comprehensively
- Executor handles dependencies, foreach, variable interpolation
- Path sandboxing prevents traversal attacks

**Ready for this sprint:**
- LLMProvider exists (OpenAI, Anthropic, Custom)
- ChatController exists but needs refinement
- Svelte components exist but need enhancement

## Scope

**In scope (this sprint):**
1. **M3: Human-Readable Plan Preview**
   - Plan summary generation (files created/modified, commands, risk)
   - PlanPreview.svelte component enhancement
   - Confirmation UI (approve/cancel)
   - Dry-run preview mode

2. **M4: LLM Integration**
   - Refine system prompt with tool schemas
   - Add retry logic for invalid JSON
   - Streaming support enhancement
   - Error handling for API failures

**Explicitly out of scope:**
- Macro save/replay (M6)
- Community plugin index (M7)
- UI polish beyond functional (M8)

## Work Items

### Phase 1: Plan Summary Generation (P0)

#### 1.1 Enhance PlanValidator with Summary

Add to PlanValidator:
```typescript
interface PlanSummary {
  goal: string;
  riskLevel: 'read-only' | 'writes' | 'commands';
  estimatedSteps: number;
  filesCreated: string[];
  filesModified: string[];
  filesDeleted: string[];
  foldersCreated: string[];
  commandsExecuted: string[];
  warnings: string[];
}
```

Analyze plan steps to extract:
- vault.createFile → filesCreated
- vault.writeFile → filesModified (or created if new)
- vault.delete → filesDeleted
- vault.ensureFolder → foldersCreated
- commands.run → commandsExecuted

#### 1.2 Risk Level Validation

Verify plan's stated riskLevel matches actual operations:
- "read-only" but has writes → warning
- "writes" but has commands → warning

### Phase 2: PlanPreview Component (P1)

#### 2.1 Enhance PlanPreview.svelte

Display:
- Goal and assumptions
- Risk level badge (color-coded)
- Collapsible step list with previews
- File operations summary
- Command operations summary
- Approve/Cancel buttons

Style with Obsidian CSS variables for native look.

#### 2.2 Add Execution Confirmation Flow

When user clicks "Execute":
1. Show confirmation modal for writes/commands
2. On approve → start execution
3. On cancel → return to preview

### Phase 3: LLM Integration Refinement (P2)

#### 3.1 Improve System Prompt

Create comprehensive system prompt in `src/prompts/systemPrompt.ts`:
- Agent identity and constraints
- Tool schemas in structured format
- ActionPlan schema with examples
- Safety guidelines
- Common patterns

#### 3.2 Add Plan Generation Retry

In ChatController or Planner service:
1. Call LLM
2. Parse JSON response
3. Validate with PlanValidator
4. If invalid, retry with error feedback (max 2 retries)
5. If still invalid, show error to user

#### 3.3 Improve Error Handling

Handle:
- Network errors → show retry option
- Rate limiting → show wait message
- Invalid API key → prompt to check settings
- Invalid JSON → retry with clarified prompt
- Validation errors → show specific issues

### Phase 4: Integration & Testing (P3)

#### 4.1 Wire Everything Together

1. ChatController sends message
2. LLM generates plan
3. PlanValidator validates
4. Summary generated
5. PlanPreview displays
6. User approves
7. Executor runs
8. Results displayed

#### 4.2 Manual Testing

- Test with sample prompts
- Verify preview accuracy
- Test error cases
- Test cancellation

## Dependencies

- Existing LLMProvider implementations
- Existing Svelte components
- PlanValidator (from M1-M2)

## Risks

1. **LLM JSON reliability**: Mitigate with retry logic and clearer prompts
2. **Streaming complexity**: Can defer streaming to polish phase if needed
3. **UI responsiveness**: Keep validation fast, show loading states

## Complexity Assessment

- Phase 1 (Summary): Low complexity
- Phase 2 (Preview): Medium complexity (Svelte work)
- Phase 3 (LLM): Medium complexity (error handling)
- Phase 4 (Integration): Low complexity

Total: Medium complexity sprint
