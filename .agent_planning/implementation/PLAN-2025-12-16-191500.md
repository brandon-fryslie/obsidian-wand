# Sprint Plan: Foundation Implementation (M1-M2)

Generated: 2025-12-16-191500

## Sprint Goal

Get the Obsidian Tool-Calling Agent to a working foundation state: TypeScript compiles cleanly, all core tools work, executor handles plans correctly, and the plugin loads in Obsidian.

## Current State Analysis

**Existing Code:**
- src/main.ts - Plugin entry point with settings UI
- src/services/ChatController.ts - Chat orchestration (has TS errors)
- src/services/Executor.ts - Plan execution (incomplete)
- src/services/LLMProvider.ts - OpenAI/Anthropic/Custom providers
- src/services/ToolsLayer.ts - All 18 tools (has TS errors)
- src/services/MacroStore.ts - Macro persistence
- src/services/PluginServices.ts - Service container
- src/views/ChatView.ts - Obsidian ItemView wrapper
- src/components/*.svelte - UI components
- src/types/ActionPlan.ts - Core types
- src/types/settings.ts - Settings types

**TypeScript Errors (54 total):**
1. Obsidian API misuse (getActiveViewOfType, commands, getLeaves)
2. Missing type annotations (error as unknown)
3. Unused imports/parameters
4. Module import issues (path)
5. Property initialization issues (strict mode)

## Scope

**In scope (this sprint):**
1. Fix all 54 TypeScript errors
2. Implement proper Obsidian API usage
3. Complete ToolsLayer with proper schemas
4. Complete Executor with proper plan validation
5. Add Zod schemas for ActionPlan and tool inputs/outputs
6. Verify plugin loads in Obsidian

**Explicitly out of scope:**
- LLM integration testing (M4)
- Chat UI polish (M5)
- Macro save/replay (M6)
- Community plugin index (M7)
- Documentation (separate sprint)

## Work Items

### Phase 1: Fix TypeScript Compilation (P0)

#### 1.1 Fix Obsidian API Usage

**Files:** src/services/ToolsLayer.ts, src/services/ChatController.ts, src/services/MacroStore.ts

**Issues:**
- `app.workspace.getActiveViewOfType("markdown")` should use `MarkdownView`
- `app.commands` is internal API, needs type casting
- `workspace.getLeaves()` should be `workspace.getLeavesOfType()`
- `view.editor` needs proper View type

**Fix approach:**
```typescript
// Before
const view = this.app.workspace.getActiveViewOfType("markdown");
view?.editor?.getSelection();

// After
import { MarkdownView } from 'obsidian';
const view = this.app.workspace.getActiveViewOfType(MarkdownView);
view?.editor?.getSelection();
```

#### 1.2 Fix Module Imports

**Files:** src/services/ToolsLayer.ts

**Issue:** `import path from "path"` doesn't work with ES modules

**Fix:** Use Obsidian's normalizePath or inline path utilities

#### 1.3 Fix Type Annotations

**Files:** Multiple

**Issues:**
- `error` typed as `unknown` in catch blocks
- Unused parameters need underscore prefix or removal
- Property initialization in classes

#### 1.4 Fix Settings Type

**File:** src/main.ts

**Issue:** Provider type mismatch in dropdown onChange

### Phase 2: Complete ToolsLayer (P1)

#### 2.1 Add Tool Registry Pattern

Currently tools are in a switch statement. Refactor to registry pattern for:
- Easier testing
- Schema validation per tool
- Better error messages

**New structure:**
```
src/tools/
  index.ts          # Tool registry
  types.ts          # Tool interfaces
  vault/
    ensureFolder.ts
    createFile.ts
    readFile.ts
    writeFile.ts
    rename.ts
    delete.ts
    searchText.ts
    listFiles.ts
  editor/
    getSelection.ts
    replaceSelection.ts
    insertAtCursor.ts
    getActiveFilePath.ts
  workspace/
    openFile.ts
    getContext.ts
  commands/
    list.ts
    run.ts
  util/
    parseMarkdownBullets.ts
    slugifyTitle.ts
```

#### 2.2 Add Zod Schemas for Each Tool

Each tool file exports:
- `inputSchema: z.ZodSchema`
- `outputSchema: z.ZodSchema`
- `execute: (app: App, args: Input) => Promise<Output>`

#### 2.3 Add Path Sandboxing

Implement `validatePath()` in a shared utility:
- No absolute paths
- No `..` traversal
- No URL schemes
- Normalize path separators

### Phase 3: Complete Executor (P2)

#### 3.1 Add Plan Validator Service

**New file:** src/services/PlanValidator.ts

**Responsibilities:**
- Validate ActionPlan against Zod schema
- Verify all tools exist in registry
- Validate tool arguments against schemas
- Check path sandboxing for vault tools
- Generate human-readable plan summary

#### 3.2 Improve Dependency Resolution

Current executor has basic dependency handling. Improve:
- Proper topological sort
- Cycle detection
- Better error messages for unmet dependencies

#### 3.3 Add Variable Resolution

Implement `$steps.stepId.field` and `$vars.name` resolution:
```typescript
function resolveValue(template: string, context: ExecutionContext): any {
  if (template.startsWith('$steps.')) {
    const [, stepId, ...path] = template.slice(1).split('.');
    return getPath(context.stepResults.get(stepId), path);
  }
  if (template.startsWith('$vars.')) {
    const [, ...path] = template.slice(1).split('.');
    return getPath(context.variables, path);
  }
  return template;
}
```

### Phase 4: Verification (P3)

#### 4.1 TypeScript Clean Compile

- `just typecheck` passes with no errors
- `just build` produces main.js

#### 4.2 Basic Runtime Test

- Plugin loads in Obsidian dev vault
- Settings page works
- Chat panel opens (even if LLM not configured)

## Dependencies

- Obsidian API documentation
- Zod library (already in package.json)
- Existing PROJECT_SPEC/ for schema definitions

## Risks

1. **Obsidian API internals**: Some APIs (commands) are internal. Mitigate with type casting and defensive checks.
2. **Path handling**: Cross-platform path issues. Use Obsidian's normalizePath.
3. **Scope creep**: Focus on compilation and structure, not features.

## Complexity Assessment

- Phase 1 (TS fixes): Low complexity, mechanical fixes
- Phase 2 (Tool registry): Medium complexity, refactoring
- Phase 3 (Executor): Medium complexity, new validation logic
- Phase 4 (Verification): Low complexity, manual testing

Total: Medium complexity sprint
