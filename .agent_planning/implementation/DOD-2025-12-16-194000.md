# Definition of Done: Plan Preview & LLM Integration (M3-M4)

Generated: 2025-12-16-194000

## Sprint Scope

**This sprint delivers:** Complete user workflow from natural language to confirmed execution
1. Human-readable plan preview with summary
2. Confirmation flow for writes/commands
3. Reliable LLM plan generation with retry
4. Error handling for all failure modes

## Acceptance Criteria

### P0: Plan Summary Generation

- [ ] PlanValidator generates PlanSummary with:
  - filesCreated, filesModified, filesDeleted lists
  - foldersCreated list
  - commandsExecuted list
  - estimatedSteps count
  - warnings for risk mismatches
- [ ] Summary accurately reflects plan operations

### P1: Plan Preview UI

- [ ] PlanPreview.svelte displays:
  - Goal statement
  - Risk level badge (read-only/writes/commands)
  - File operations summary
  - Command summary (if any)
  - Step-by-step preview (collapsible)
  - Approve and Cancel buttons
- [ ] Approve triggers execution
- [ ] Cancel returns to chat
- [ ] Styles match Obsidian native look

### P2: LLM Plan Generation

- [ ] System prompt includes tool schemas
- [ ] LLM generates valid ActionPlan JSON
- [ ] Invalid JSON triggers retry (max 2 times)
- [ ] Validation errors trigger retry with feedback
- [ ] Final failure shows clear error to user

### P3: Error Handling

- [ ] Network errors: show retry button
- [ ] API errors: show specific message
- [ ] Invalid API key: prompt to check settings
- [ ] Rate limiting: show wait message
- [ ] All errors are user-friendly (no stack traces)

### P4: Integration

- [ ] Full flow works: message → plan → preview → execute → results
- [ ] Loading states shown during LLM call
- [ ] Progress shown during execution
- [ ] Results shown after completion

## Sprint Complete When

- [ ] All P0-P3 criteria met
- [ ] P4 integration verified manually
- [ ] `just typecheck` passes
- [ ] `just build` succeeds
