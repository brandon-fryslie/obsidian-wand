# Plan: Tool-Centric Plan Management Interface

**Created**: 2025-12-17
**Topic**: Tool Interface for Plan Management
**Status**: Draft

---

## Vision

Replace the chat-centric paradigm with a **tool-centric plan management interface** where:
- Plans are first-class objects you can inspect, manage, and track
- The interface is structured around **outstanding work** rather than conversation history
- Users have direct visibility into plan status, dependencies, and execution state
- Prompts create/update plans within a structured workflow

This transforms "Wand" from a chatbot into a **plan orchestration dashboard**.

---

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        PLAN MANAGEMENT INTERFACE                        │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────────────────────────────────┐  │
│  │  Plan Queue     │  │              Active Plan Detail              │  │
│  │  ┌───────────┐  │  │  ┌─────────────────────────────────────────┐│  │
│  │  │ ● Plan A  │  │  │  │ Goal: Create notes from bullets         ││  │
│  │  │ ○ Plan B  │  │  │  ├─────────────────────────────────────────┤│  │
│  │  │ ○ Plan C  │  │  │  │ Status: Awaiting Approval               ││  │
│  │  │ ◐ Plan D  │  │  │  │ Steps: 12 | Risk: writes                ││  │
│  │  └───────────┘  │  │  ├─────────────────────────────────────────┤│  │
│  │                 │  │  │ Steps:                                   ││  │
│  │  [+ New Plan]   │  │  │ ☑ 1. Ensure folder exists               ││  │
│  │                 │  │  │ ☑ 2. Parse bullets                      ││  │
│  │  ─────────────  │  │  │ ☐ 3. Create file (foreach: 10 items)   ││  │
│  │  Filters:       │  │  │ ☐ 4. Replace selection with links       ││  │
│  │  [All ▼]        │  │  └─────────────────────────────────────────┘│  │
│  │  ☐ Pending      │  │                                              │  │
│  │  ☐ Executing    │  │  [Approve All] [Edit Plan] [Cancel]         │  │
│  │  ☐ Completed    │  │                                              │  │
│  │  ☐ Failed       │  └─────────────────────────────────────────────┘  │
│  └─────────────────┘                                                    │
├─────────────────────────────────────────────────────────────────────────┤
│  [Prompt: "What would you like to do?"]                    [Generate] │  │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Phase 1: Core Data Model

**Goal**: Define the Plan entity with all metadata needed for management.

### Deliverables

1. **Plan Entity** (`src/types/Plan.ts`)
   ```typescript
   interface Plan {
     id: string;
     title: string;                    // Short descriptive title
     goal: string;                     // Full goal statement
     status: PlanStatus;
     priority: number;                 // 1-5, higher = more urgent
     createdAt: Date;
     updatedAt: Date;

     // From ActionPlan
     actionPlan: ActionPlan;
     summary: PlanSummary;
     warnings: string[];

     // Execution state
     executionState?: ExecutionState;
     executionHistory: ExecutionAttempt[];

     // Relationships
     parentId?: string;                // For sub-plans
     dependsOn: string[];              // Plans that must complete first
     tags: string[];

     // User annotations
     notes?: string;
     pinned: boolean;
   }

   type PlanStatus =
     | 'draft'           // Just created, not yet validated
     | 'pending'         // Validated, awaiting approval
     | 'approved'        // User approved, ready to execute
     | 'executing'       // Currently running
     | 'paused'          // Execution paused (can resume)
     | 'completed'       // Successfully finished
     | 'failed'          // Execution failed
     | 'cancelled';      // User cancelled

   interface ExecutionAttempt {
     id: string;
     startedAt: Date;
     endedAt?: Date;
     status: 'running' | 'completed' | 'failed' | 'cancelled';
     result?: ExecutionResult;
     error?: string;
   }
   ```

2. **Plan Events** (`src/types/PlanEvents.ts`)
   ```typescript
   type PlanEvent =
     | { type: 'created'; plan: Plan }
     | { type: 'updated'; plan: Plan; changes: Partial<Plan> }
     | { type: 'status-changed'; planId: string; from: PlanStatus; to: PlanStatus }
     | { type: 'execution-started'; planId: string; attemptId: string }
     | { type: 'execution-progress'; planId: string; step: number; total: number }
     | { type: 'execution-completed'; planId: string; result: ExecutionResult }
     | { type: 'deleted'; planId: string };
   ```

3. **Plan Filters** (`src/types/PlanFilters.ts`)
   ```typescript
   interface PlanFilters {
     status?: PlanStatus[];
     tags?: string[];
     search?: string;
     dateRange?: { from: Date; to: Date };
     priority?: number[];
     sortBy: 'createdAt' | 'updatedAt' | 'priority' | 'title';
     sortOrder: 'asc' | 'desc';
   }
   ```

### Acceptance Criteria
- [ ] Plan type definition complete with all fields
- [ ] PlanStatus enum covers all lifecycle states
- [ ] ExecutionAttempt tracks history of runs
- [ ] PlanEvent types support reactive UI updates
- [ ] PlanFilters enable flexible querying

---

## Phase 2: Plan Store Service

**Goal**: Centralized state management for plans with persistence.

### Deliverables

1. **PlanStore Service** (`src/services/PlanStore.ts`)
   ```typescript
   class PlanStore {
     // Core CRUD
     create(draft: PlanDraft): Plan;
     get(id: string): Plan | undefined;
     update(id: string, changes: Partial<Plan>): Plan;
     delete(id: string): void;

     // Queries
     list(filters?: PlanFilters): Plan[];
     getActive(): Plan | undefined;  // Currently selected/executing
     getPending(): Plan[];
     getByStatus(status: PlanStatus): Plan[];

     // Lifecycle
     approve(id: string): void;
     execute(id: string): Promise<ExecutionResult>;
     pause(id: string): void;
     resume(id: string): void;
     cancel(id: string): void;
     retry(id: string): void;

     // Events
     subscribe(callback: (event: PlanEvent) => void): () => void;

     // Persistence
     save(): Promise<void>;
     load(): Promise<void>;
   }
   ```

2. **Svelte Store Wrapper** (`src/stores/planStore.ts`)
   ```typescript
   // Reactive store for Svelte components
   export const plans = writable<Plan[]>([]);
   export const activePlanId = writable<string | null>(null);
   export const filters = writable<PlanFilters>(defaultFilters);

   // Derived stores
   export const filteredPlans = derived([plans, filters], ...);
   export const activePlan = derived([plans, activePlanId], ...);
   export const pendingCount = derived(plans, ...);
   export const executingPlan = derived(plans, ...);
   ```

3. **Persistence Layer**
   - Save plans to `.obsidian/plugins/wand/plans.json`
   - Auto-save on changes (debounced)
   - Load on plugin startup
   - Handle migration for schema changes

### Acceptance Criteria
- [ ] CRUD operations work correctly
- [ ] Filtering returns correct results
- [ ] Events emit for all state changes
- [ ] Persistence survives plugin reload
- [ ] Svelte stores update reactively

---

## Phase 3: Plan List View

**Goal**: Display all plans with filtering and selection.

### Deliverables

1. **PlanList Component** (`src/components/PlanList.svelte`)
   - Scrollable list of plan cards
   - Visual status indicators (icons, colors)
   - Selection highlighting
   - Right-click context menu
   - Keyboard navigation (up/down/enter)

2. **PlanCard Component** (`src/components/PlanCard.svelte`)
   ```
   ┌─────────────────────────────────────┐
   │ ● Create daily note templates    P2 │
   │   3 steps | writes | 2m ago         │
   │   [executing ████░░░░ 60%]          │
   └─────────────────────────────────────┘
   ```
   - Status indicator (●○◐◉✓✗)
   - Title (truncated with ellipsis)
   - Priority badge
   - Step count and risk level
   - Relative timestamp
   - Progress bar (if executing)
   - Click to select, double-click to view detail

3. **PlanFiltersBar Component** (`src/components/PlanFiltersBar.svelte`)
   - Status filter dropdown
   - Tag filter chips
   - Search input
   - Sort dropdown
   - "Clear filters" button

4. **Empty States**
   - No plans: "Create your first plan"
   - No matches: "No plans match your filters"

### Acceptance Criteria
- [ ] Plans display in scrollable list
- [ ] Status visually distinguishable
- [ ] Clicking selects plan
- [ ] Filters narrow list correctly
- [ ] Empty states show appropriate messages

---

## Phase 4: Plan Detail View

**Goal**: Comprehensive view of a single plan with actions.

### Deliverables

1. **PlanDetail Component** (`src/components/PlanDetail.svelte`)
   - Header: Title, status badge, priority
   - Goal section (full text)
   - Steps list with checkboxes
   - Warnings panel (if any)
   - Execution history accordion
   - Notes section (editable)
   - Action buttons

2. **StepInspector Component** (`src/components/StepInspector.svelte`)
   - Expandable step details
   - Tool name and arguments
   - Preview text
   - Dependency indicators
   - Execution result (if run)

3. **ExecutionTimeline Component** (`src/components/ExecutionTimeline.svelte`)
   - Visual timeline of execution attempts
   - Success/failure indicators
   - Duration display
   - Error details (expandable)

4. **Action Buttons**
   - Primary: Approve / Execute / Retry
   - Secondary: Edit, Duplicate, Cancel, Delete
   - Contextual based on status

### Acceptance Criteria
- [ ] All plan details visible
- [ ] Steps expandable to show details
- [ ] Execution history visible
- [ ] Actions work correctly per status
- [ ] Notes editable and persist

---

## Phase 5: Plan Creation Flow

**Goal**: Structured prompt → plan creation workflow.

### Deliverables

1. **PromptInput Component** (`src/components/PromptInput.svelte`)
   - Textarea with placeholder
   - Context indicator (selection, active file)
   - Template suggestions
   - Submit button
   - Keyboard shortcut (Cmd+Enter)

2. **Plan Generation Service** (extend `ChatController`)
   - Accept prompt
   - Gather context
   - Call LLM
   - Create Plan entity
   - Add to PlanStore
   - Auto-select new plan

3. **Creation Feedback**
   - Loading state during generation
   - Success: Plan appears in list, auto-selected
   - Failure: Error message, retry option

4. **Quick Actions**
   - "New Plan" button in header
   - Template buttons (daily note, organize, etc.)
   - Recent prompts history

### Acceptance Criteria
- [ ] Prompt input accepts text
- [ ] Context (selection) included automatically
- [ ] Plan generated and added to list
- [ ] New plan auto-selected
- [ ] Errors handled gracefully

---

## Phase 6: Plan Execution Engine

**Goal**: Execute plans with progress tracking and control.

### Deliverables

1. **Execution Manager** (`src/services/ExecutionManager.ts`)
   ```typescript
   class ExecutionManager {
     execute(plan: Plan): Promise<ExecutionResult>;
     pause(): void;
     resume(): void;
     cancel(): void;

     // Progress
     onProgress(callback: (progress: ExecutionProgress) => void): () => void;
     getProgress(): ExecutionProgress | null;
   }
   ```

2. **ExecutionProgress Component** (enhance existing)
   - Step-by-step progress
   - Current step highlight
   - Timing information
   - Cancel button
   - Error display (if step fails)

3. **Background Execution**
   - Plans can execute while browsing other plans
   - Global progress indicator
   - Notifications on completion

4. **Execution Controls**
   - Pause mid-execution
   - Resume paused execution
   - Cancel with cleanup
   - Retry failed plans

### Acceptance Criteria
- [ ] Plans execute step-by-step
- [ ] Progress visible in real-time
- [ ] Pause/resume works
- [ ] Cancel stops execution
- [ ] Failed plans can retry

---

## Phase 7: Plan Progress Tracking

**Goal**: Track and visualize plan progress over time.

### Deliverables

1. **Progress Dashboard** (`src/components/ProgressDashboard.svelte`)
   ```
   ┌─────────────────────────────────────┐
   │ Today's Progress                    │
   │ ████████████░░░░░░ 8/12 plans done  │
   │                                     │
   │ ✓ 8 completed  ● 2 pending          │
   │ ◐ 1 executing  ✗ 1 failed           │
   └─────────────────────────────────────┘
   ```

2. **Plan Statistics**
   - Total plans by status
   - Completion rate
   - Average execution time
   - Most used tools

3. **Activity Log** (`src/components/ActivityLog.svelte`)
   - Chronological list of plan events
   - Filter by event type
   - Links to plans

4. **Notifications**
   - Plan completed
   - Plan failed
   - Execution paused (needs attention)

### Acceptance Criteria
- [ ] Dashboard shows overall progress
- [ ] Statistics calculated correctly
- [ ] Activity log shows recent events
- [ ] Notifications display appropriately

---

## Phase 8: Plan Templates & Presets

**Goal**: Reusable plan patterns for common tasks.

### Deliverables

1. **Template System** (`src/services/TemplateStore.ts`)
   ```typescript
   interface PlanTemplate {
     id: string;
     name: string;
     description: string;
     category: string;
     actionPlan: ActionPlan;  // With ${param} placeholders
     parameters: TemplateParameter[];
     icon?: string;
   }

   interface TemplateParameter {
     name: string;
     type: 'string' | 'number' | 'file' | 'folder' | 'selection';
     description: string;
     default?: string;
     required: boolean;
   }
   ```

2. **Template Gallery** (`src/components/TemplateGallery.svelte`)
   - Grid of template cards
   - Category filter
   - Search
   - "Use Template" button

3. **Parameter Form** (`src/components/ParameterForm.svelte`)
   - Dynamic form from template parameters
   - Validation
   - Preview of resulting plan
   - Create plan button

4. **Save as Template**
   - From any completed plan
   - Identify parameters (paths, names)
   - Save to template library

5. **Built-in Templates**
   - Create daily note
   - Organize notes by tag
   - Create from template
   - Bulk rename
   - Archive old notes

### Acceptance Criteria
- [ ] Templates displayed in gallery
- [ ] Parameters form renders correctly
- [ ] Plan created from template works
- [ ] Save as template extracts parameters
- [ ] Built-in templates available

---

## Phase 9: Plan Dependencies & Linking

**Goal**: Connect related plans with dependencies.

### Deliverables

1. **Dependency System**
   ```typescript
   interface PlanDependency {
     planId: string;
     dependsOnId: string;
     type: 'blocks' | 'related' | 'parent-child';
   }
   ```

2. **Dependency Visualization** (`src/components/DependencyGraph.svelte`)
   - Visual graph of plan relationships
   - Click to navigate
   - Status colors
   - Cycle detection

3. **Dependency Management**
   - Add dependency from detail view
   - Auto-block execution if dependencies not met
   - Clear dependency on completion

4. **Plan Grouping**
   - Parent-child relationships
   - Expand/collapse in list
   - Bulk operations on group

5. **Smart Suggestions**
   - Suggest dependencies based on file overlap
   - Warn about conflicts (same files)

### Acceptance Criteria
- [ ] Dependencies can be added/removed
- [ ] Blocked plans show dependency status
- [ ] Graph visualization works
- [ ] Parent-child grouping works
- [ ] Conflicts detected and warned

---

## Migration Strategy

### From Chat Interface

1. **Preserve existing functionality** - Chat still works
2. **Add Plan view as new tab/mode**
3. **Plans generated from chat appear in Plan view**
4. **Gradual migration** - Users can use either
5. **Eventually** - Chat becomes secondary, Plan view primary

### Data Migration

1. **Existing macros** → Convert to templates
2. **No breaking changes** to settings

---

## File Structure

```
src/
├── types/
│   ├── Plan.ts              # Phase 1
│   ├── PlanEvents.ts        # Phase 1
│   └── PlanFilters.ts       # Phase 1
├── services/
│   ├── PlanStore.ts         # Phase 2
│   ├── ExecutionManager.ts  # Phase 6
│   └── TemplateStore.ts     # Phase 8
├── stores/
│   └── planStore.ts         # Phase 2
├── components/
│   ├── PlanList.svelte      # Phase 3
│   ├── PlanCard.svelte      # Phase 3
│   ├── PlanFiltersBar.svelte# Phase 3
│   ├── PlanDetail.svelte    # Phase 4
│   ├── StepInspector.svelte # Phase 4
│   ├── ExecutionTimeline.svelte # Phase 4
│   ├── PromptInput.svelte   # Phase 5
│   ├── ProgressDashboard.svelte # Phase 7
│   ├── ActivityLog.svelte   # Phase 7
│   ├── TemplateGallery.svelte # Phase 8
│   ├── ParameterForm.svelte # Phase 8
│   └── DependencyGraph.svelte # Phase 9
└── views/
    └── PlanView.ts          # Phase 3 (main view)
```

---

## Summary

| Phase | Focus | Key Deliverables |
|-------|-------|------------------|
| 1 | Data Model | Plan types, events, filters |
| 2 | Store Service | CRUD, persistence, Svelte stores |
| 3 | List View | PlanList, PlanCard, filters |
| 4 | Detail View | PlanDetail, StepInspector, timeline |
| 5 | Creation Flow | PromptInput, generation integration |
| 6 | Execution Engine | ExecutionManager, progress, controls |
| 7 | Progress Tracking | Dashboard, stats, activity log |
| 8 | Templates | Template system, gallery, parameter form |
| 9 | Dependencies | Dependency graph, grouping, smart suggestions |

This transforms the plugin from a conversational chatbot into a **plan orchestration system** where users have full visibility and control over their automation workflows.
